<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>abics.applications.latgas_abinitio_interface.model_setup &mdash; abICS API  documentation</title>
      <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/sphinx_highlight.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            abICS API
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../abics.html">abics package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">abICS API</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">abics.applications.latgas_abinitio_interface.model_setup</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for abics.applications.latgas_abinitio_interface.model_setup</h1><div class="highlight"><pre>
<span></span><span class="c1"># ab-Initio Configuration Sampling tool kit (abICS)</span>
<span class="c1"># Copyright (C) 2019- The University of Tokyo</span>
<span class="c1">#</span>
<span class="c1"># This program is free software: you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU General Public License as published by</span>
<span class="c1"># the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1"># (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1"># This program is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="c1"># GNU General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU General Public License</span>
<span class="c1"># along with this program. If not, see http://www.gnu.org/licenses/.</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">itertools</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numpy.random</span> <span class="k">as</span> <span class="nn">rand</span>
<span class="kn">from</span> <span class="nn">scipy.special</span> <span class="kn">import</span> <span class="n">gammaln</span>

<span class="kn">from</span> <span class="nn">pymatgen.core</span> <span class="kn">import</span> <span class="n">Structure</span>
<span class="kn">from</span> <span class="nn">pymatgen.analysis.structure_matcher</span> <span class="kn">import</span> <span class="n">StructureMatcher</span><span class="p">,</span> <span class="n">FrameworkComparator</span>
<span class="kn">import</span> <span class="nn">pymatgen.analysis.structure_analyzer</span> <span class="k">as</span> <span class="nn">analy</span>

<span class="kn">from</span> <span class="nn">abics</span> <span class="kn">import</span> <span class="n">__version__</span>
<span class="kn">from</span> <span class="nn">abics.exception</span> <span class="kn">import</span> <span class="n">InputError</span>
<span class="kn">from</span> <span class="nn">abics.mc</span> <span class="kn">import</span> <span class="n">Model</span>
<span class="kn">from</span> <span class="nn">abics.util</span> <span class="kn">import</span> <span class="n">read_vector</span><span class="p">,</span> <span class="n">read_matrix</span><span class="p">,</span> <span class="n">read_tensor</span>
<span class="kn">from</span> <span class="nn">abics.applications.latgas_abinitio_interface</span> <span class="kn">import</span> <span class="n">map2perflat</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;main&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="gauss"><a class="viewcode-back" href="../../../../abics.applications.latgas_abinitio_interface.model_setup.html#abics.applications.latgas_abinitio_interface.model_setup.gauss">[docs]</a><span class="k">def</span> <span class="nf">gauss</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gaussian function</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x: float</span>
<span class="sd">        The position</span>
<span class="sd">    x0: float</span>
<span class="sd">        The position of the center of the peak</span>
<span class="sd">    sigma: float</span>
<span class="sd">        The standard deviation</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        value: float</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="mf">1.0</span>
        <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">/</span> <span class="n">sigma</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="match_id"><a class="viewcode-back" href="../../../../abics.applications.latgas_abinitio_interface.model_setup.html#abics.applications.latgas_abinitio_interface.model_setup.match_id">[docs]</a><span class="k">def</span> <span class="nf">match_id</span><span class="p">(</span><span class="n">lst</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the index list of lst which matches obj.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lst: list</span>
<span class="sd">    obj: object</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        The index list of lst which matches obj.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span> <span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="n">obj</span> <span class="p">]</span></div>

<div class="viewcode-block" id="nomatch_id"><a class="viewcode-back" href="../../../../abics.applications.latgas_abinitio_interface.model_setup.html#abics.applications.latgas_abinitio_interface.model_setup.nomatch_id">[docs]</a><span class="k">def</span> <span class="nf">nomatch_id</span><span class="p">(</span><span class="n">lst</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the index list of lst which does not match obj.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lst: list</span>
<span class="sd">    obj: object</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        The index list of lst which does not match obj.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span> <span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span> <span class="o">!=</span> <span class="n">obj</span> <span class="p">]</span></div>

<div class="viewcode-block" id="match_latgas_group"><a class="viewcode-back" href="../../../../abics.applications.latgas_abinitio_interface.model_setup.html#abics.applications.latgas_abinitio_interface.model_setup.match_latgas_group">[docs]</a><span class="k">def</span> <span class="nf">match_latgas_group</span><span class="p">(</span><span class="n">latgas_rep</span><span class="p">,</span> <span class="n">group</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the index list of latgas_rep which matches group.name.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    latgas_rep: list</span>
<span class="sd">    group: object</span>
<span class="sd">        Notes: the group must have name</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        The index list of latgas_rep which matches group.name.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span> <span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">latgas_rep</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">group</span><span class="o">.</span><span class="n">name</span> <span class="p">]</span></div>

<div class="viewcode-block" id="perturb_structure"><a class="viewcode-back" href="../../../../abics.applications.latgas_abinitio_interface.model_setup.html#abics.applications.latgas_abinitio_interface.model_setup.perturb_structure">[docs]</a><span class="k">def</span> <span class="nf">perturb_structure</span><span class="p">(</span><span class="n">st</span><span class="p">:</span> <span class="n">Structure</span><span class="p">,</span> <span class="n">distance</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform random perturbation of the atomic coordinates.</span>
<span class="sd">    All atoms will be moved at the same distance.</span>

<span class="sd">    Which components will be perturbed is specified by a boolean array stored as st.site_properties[&quot;seldyn&quot;].</span>
<span class="sd">    If not stored, all the components will be perturbed.</span>
<span class="sd">    Argument st will be mutated.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    st: Structure</span>
<span class="sd">    distance: float</span>
<span class="sd">        strength of perturb</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">num_sites</span>
    <span class="n">seldyn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">site_properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;seldyn&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="mi">3</span><span class="p">))),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">seldyn</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">seldyn</span> <span class="o">*=</span> <span class="n">rand</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">seldyn</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">norm</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">sites</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span> <span class="o">+=</span> <span class="n">seldyn</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">norm</span> <span class="o">*</span> <span class="n">distance</span></div>


<div class="viewcode-block" id="DFTLatticeGas"><a class="viewcode-back" href="../../../../abics.applications.latgas_abinitio_interface.model_setup.html#abics.applications.latgas_abinitio_interface.model_setup.DFTLatticeGas">[docs]</a><span class="k">class</span> <span class="nc">DFTLatticeGas</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class defines the DFT lattice gas mapping model</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">model_name</span> <span class="o">=</span> <span class="s2">&quot;DFTLatticeGas&quot;</span>

<div class="viewcode-block" id="DFTLatticeGas.__init__"><a class="viewcode-back" href="../../../../abics.applications.latgas_abinitio_interface.model_setup.html#abics.applications.latgas_abinitio_interface.model_setup.DFTLatticeGas.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">abinitio_run</span><span class="p">,</span>
        <span class="n">save_history</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">l_update_basestruct</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">check_ion_move</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">ion_move_tol</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
        <span class="n">enable_grandcanonical</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">gc_ratio</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
        <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        abinitio_run:          runner object</span>
<span class="sd">            Runner (manager) of external solver program</span>
<span class="sd">        save_history:          boolean</span>
<span class="sd">        l_update_basestruct:   boolean</span>
<span class="sd">        check_ion_move:        boolean</span>
<span class="sd">        ion_move_tol:          float</span>
<span class="sd">        enable_grandcanonical: boolean</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">matcher</span> <span class="o">=</span> <span class="n">StructureMatcher</span><span class="p">(</span><span class="n">primitive_cell</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">allow_subset</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">abinitio_run</span> <span class="o">=</span> <span class="n">abinitio_run</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_history</span> <span class="o">=</span> <span class="n">save_history</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l_update_basestruct</span> <span class="o">=</span> <span class="n">l_update_basestruct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_ion_move</span> <span class="o">=</span> <span class="n">check_ion_move</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ion_move_tol</span> <span class="o">=</span> <span class="n">ion_move_tol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enable_grandcanonical</span> <span class="o">=</span> <span class="n">enable_grandcanonical</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gc_ratio</span> <span class="o">=</span> <span class="n">gc_ratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;debug mode enabled&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;enable_grandcanonical = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">enable_grandcanonical</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;gc_ratio = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gc_ratio</span><span class="p">))</span></div>

<div class="viewcode-block" id="DFTLatticeGas.energy"><a class="viewcode-back" href="../../../../abics.applications.latgas_abinitio_interface.model_setup.html#abics.applications.latgas_abinitio_interface.model_setup.DFTLatticeGas.energy">[docs]</a>    <span class="k">def</span> <span class="nf">energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">energy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">config</span><span class="o">.</span><span class="n">energy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">internal_energy</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_grandcanonical</span><span class="p">:</span>
                <span class="n">config</span><span class="o">.</span><span class="n">energy</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_muN_term</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">config</span><span class="o">.</span><span class="n">energy</span></div>

<div class="viewcode-block" id="DFTLatticeGas.internal_energy"><a class="viewcode-back" href="../../../../abics.applications.latgas_abinitio_interface.model_setup.html#abics.applications.latgas_abinitio_interface.model_setup.DFTLatticeGas.internal_energy">[docs]</a>    <span class="k">def</span> <span class="nf">internal_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">internal_energy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">config</span><span class="o">.</span><span class="n">internal_energy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_energy</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">config</span><span class="o">.</span><span class="n">internal_energy</span></div>

    <span class="k">def</span> <span class="nf">_calc_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate total energy</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        config: config object</span>
<span class="sd">            Configurations</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        energy: float</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">config</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">site</span><span class="p">:</span> <span class="n">site</span><span class="o">.</span><span class="n">species_string</span><span class="p">)</span>
        <span class="n">structure</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">structure</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_history</span><span class="p">:</span>
            <span class="c1"># Try to avoid doing dft calculation for the same structure.</span>
            <span class="c1"># Assuming that calc_history is a list of ComputedStructureEntries</span>
            <span class="k">for</span> <span class="n">hist</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">calc_history</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">matcher</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">hist</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;match found in history&quot;</span><span class="p">)</span>
                    <span class="n">config</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="n">hist</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="k">return</span> <span class="n">hist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">structure0</span> <span class="o">=</span> <span class="n">structure</span>
        <span class="n">energy</span><span class="p">,</span> <span class="n">structure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abinitio_run</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span>
            <span class="n">structure</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s2">&quot;output&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_ion_move</span><span class="p">:</span>
            <span class="n">relax_analy</span> <span class="o">=</span> <span class="n">analy</span><span class="o">.</span><span class="n">RelaxationAnalyzer</span><span class="p">(</span><span class="n">structure0</span><span class="p">,</span> <span class="n">structure</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">relax_analy</span><span class="o">.</span><span class="n">get_percentage_bond_dist_changes</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">ion</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_ion_move</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">structure0</span><span class="o">.</span><span class="n">indices_from_symbol</span><span class="p">(</span><span class="n">ion</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">v</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ion_move_tol</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()]):</span>
                        <span class="n">energy</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;ion relaxed out of initial site&quot;</span><span class="p">)</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_history</span><span class="p">:</span>
            <span class="n">config</span><span class="o">.</span><span class="n">calc_history</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">energy</span><span class="p">,</span> <span class="n">structure0</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">structure</span><span class="o">.</span><span class="n">copy</span><span class="p">()))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">calc_history</span><span class="p">)</span> <span class="o">==</span> <span class="mi">25</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">config</span><span class="o">.</span><span class="n">calc_history</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>
        <span class="n">config</span><span class="o">.</span><span class="n">structure_norel</span> <span class="o">=</span> <span class="n">structure0</span>
        <span class="n">config</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="n">structure</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_calc_num_species</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">species</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">sublat</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">defect_sublattices</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">([</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sublat</span><span class="o">.</span><span class="n">latgas_rep</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">species</span> <span class="p">])</span>
        <span class="k">return</span> <span class="n">n</span>

    <span class="k">def</span> <span class="nf">_calc_muN_term</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="n">muN</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">chem</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">chemical_potential</span><span class="p">:</span>
            <span class="n">sps</span> <span class="o">=</span> <span class="n">chem</span><span class="p">[</span><span class="s1">&#39;species&#39;</span><span class="p">]</span>
            <span class="n">mu</span> <span class="o">=</span> <span class="n">chem</span><span class="p">[</span><span class="s1">&#39;mu&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">sps</span><span class="p">:</span>
                <span class="n">muN</span> <span class="o">+=</span> <span class="n">mu</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_num_species</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">sp</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">muN</span>

    <span class="k">def</span> <span class="nf">_calc_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="n">w</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">sublat</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">defect_sublattices</span><span class="p">:</span>
            <span class="n">nsite</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sublat</span><span class="o">.</span><span class="n">latgas_rep</span><span class="p">)</span>
            <span class="n">w</span> <span class="o">+=</span> <span class="n">gammaln</span><span class="p">(</span><span class="n">nsite</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">sublat</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span>
                <span class="n">ngrp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">match_latgas_group</span><span class="p">(</span><span class="n">sublat</span><span class="o">.</span><span class="n">latgas_rep</span><span class="p">,</span> <span class="n">grp</span><span class="p">))</span>
                <span class="n">w</span> <span class="o">-=</span> <span class="n">gammaln</span><span class="p">(</span><span class="n">ngrp</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">w</span>

    <span class="k">def</span> <span class="nf">_find_num_group_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="n">num</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">sublat</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">defect_sublattices</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">sublat</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span>
                <span class="n">ngrp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">match_latgas_group</span><span class="p">(</span><span class="n">sublat</span><span class="o">.</span><span class="n">latgas_rep</span><span class="p">,</span> <span class="n">grp</span><span class="p">))</span>
                <span class="n">num</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ngrp</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">num</span>

    <span class="k">def</span> <span class="nf">_calc_dweight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial</span><span class="p">,</span> <span class="n">final</span><span class="p">):</span>
        <span class="n">w</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">f</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">initial</span><span class="p">,</span> <span class="n">final</span><span class="p">):</span>
            <span class="k">while</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">f</span><span class="p">:</span>
                <span class="n">w</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="n">f</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">while</span> <span class="n">i</span><span class="o">&gt;</span><span class="n">f</span><span class="p">:</span>
                <span class="n">w</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">w</span>

    <span class="k">def</span> <span class="nf">_try_rotate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">defect_sublattice</span><span class="p">):</span>
        <span class="n">latgas_rep</span> <span class="o">=</span> <span class="n">defect_sublattice</span><span class="o">.</span><span class="n">latgas_rep</span>

        <span class="n">rot_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">defect_sublattice</span><span class="o">.</span><span class="n">groups_orr</span><span class="p">:</span>
            <span class="n">rot_ids</span> <span class="o">+=</span> <span class="n">match_latgas_group</span><span class="p">(</span><span class="n">latgas_rep</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rot_ids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;try_rotate: list empty. retry&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="p">{</span> <span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="s1">&#39;rotate&#39;</span><span class="p">,</span> <span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="s1">&#39;empty&#39;</span> <span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Choose the site to rotate and rotate</span>
        <span class="n">rot_id</span> <span class="o">=</span> <span class="n">rand</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">rot_ids</span><span class="p">)</span>
        <span class="n">rot_group</span> <span class="o">=</span> <span class="n">defect_sublattice</span><span class="o">.</span><span class="n">group_dict</span><span class="p">[</span><span class="n">latgas_rep</span><span class="p">[</span><span class="n">rot_id</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">rot_group_orr</span> <span class="o">=</span> <span class="n">latgas_rep</span><span class="p">[</span><span class="n">rot_id</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Remove the current orientation from the list of possible orientations</span>
        <span class="n">or_choices</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">orx</span> <span class="k">for</span> <span class="n">orx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rot_group</span><span class="o">.</span><span class="n">orientations</span><span class="p">)</span> <span class="k">if</span> <span class="n">orx</span> <span class="o">!=</span> <span class="n">rot_group_orr</span>
        <span class="p">]</span>
        <span class="n">new_orr</span> <span class="o">=</span> <span class="n">rand</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">or_choices</span><span class="p">)</span>
        <span class="n">latgas_rep</span><span class="p">[</span><span class="n">rot_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">rot_group</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">new_orr</span><span class="p">]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;try_rotate: rotate id=</span><span class="si">{}</span><span class="s2">, group=</span><span class="si">{}</span><span class="s2">, from=</span><span class="si">{}</span><span class="s2">, to=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">rot_id</span><span class="p">,</span> <span class="n">rot_group</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">rot_group_orr</span><span class="p">,</span> <span class="n">new_orr</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="p">{</span> <span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="s1">&#39;rotate&#39;</span><span class="p">,</span> <span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="s1">&#39;ok&#39;</span><span class="p">,</span> <span class="s1">&#39;rot_id&#39;</span><span class="p">:</span> <span class="n">rot_id</span><span class="p">,</span> <span class="s1">&#39;rot_group&#39;</span><span class="p">:</span> <span class="n">rot_group</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;from&#39;</span><span class="p">:</span> <span class="n">rot_group_orr</span><span class="p">,</span> <span class="s1">&#39;to&#39;</span><span class="p">:</span> <span class="n">new_orr</span> <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_try_exchange</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">defect_sublattice</span><span class="p">):</span>
        <span class="n">latgas_rep</span> <span class="o">=</span> <span class="n">defect_sublattice</span><span class="o">.</span><span class="n">latgas_rep</span>

        <span class="c1"># Exchange different groups between sites</span>
        <span class="n">ex1_group</span><span class="p">,</span> <span class="n">ex2_group</span> <span class="o">=</span> <span class="n">rand</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
            <span class="n">defect_sublattice</span><span class="o">.</span><span class="n">groups</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">ex1_idlist</span> <span class="o">=</span> <span class="n">match_latgas_group</span><span class="p">(</span><span class="n">latgas_rep</span><span class="p">,</span> <span class="n">ex1_group</span><span class="p">)</span>
        <span class="n">ex2_idlist</span> <span class="o">=</span> <span class="n">match_latgas_group</span><span class="p">(</span><span class="n">latgas_rep</span><span class="p">,</span> <span class="n">ex2_group</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ex1_idlist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">ex2_idlist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;try_exchange: list empty </span><span class="si">{}</span><span class="s2">(</span><span class="si">{}</span><span class="s2">), </span><span class="si">{}</span><span class="s2">(</span><span class="si">{}</span><span class="s2">). retry&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">ex1_group</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ex1_idlist</span><span class="p">),</span> <span class="n">ex2_group</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ex2_idlist</span><span class="p">)))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="p">{</span> <span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="s1">&#39;exchange&#39;</span><span class="p">,</span> <span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="s1">&#39;empty&#39;</span> <span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="n">ex1_id</span> <span class="o">=</span> <span class="n">rand</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">ex1_idlist</span><span class="p">)</span>
        <span class="n">ex2_id</span> <span class="o">=</span> <span class="n">rand</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">ex2_idlist</span><span class="p">)</span>
        <span class="n">latgas_rep</span><span class="p">[</span><span class="n">ex1_id</span><span class="p">],</span> <span class="n">latgas_rep</span><span class="p">[</span><span class="n">ex2_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">latgas_rep</span><span class="p">[</span><span class="n">ex2_id</span><span class="p">],</span>
            <span class="n">latgas_rep</span><span class="p">[</span><span class="n">ex1_id</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;try_exchange: exchange </span><span class="si">{}</span><span class="s2">(</span><span class="si">{}</span><span class="s2">) and </span><span class="si">{}</span><span class="s2">(</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">ex1_id</span><span class="p">,</span> <span class="n">ex1_group</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ex2_id</span><span class="p">,</span> <span class="n">ex2_group</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="p">{</span> <span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="s1">&#39;exchange&#39;</span><span class="p">,</span> <span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="s1">&#39;ok&#39;</span><span class="p">,</span> <span class="s1">&#39;ex1_id&#39;</span><span class="p">:</span> <span class="n">ex1_id</span><span class="p">,</span> <span class="s1">&#39;ex1_group&#39;</span><span class="p">:</span> <span class="n">ex1_group</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;ex2_id&#39;</span><span class="p">:</span> <span class="n">ex2_id</span><span class="p">,</span> <span class="s1">&#39;ex2_group&#39;</span><span class="p">:</span> <span class="n">ex2_group</span><span class="o">.</span><span class="n">name</span> <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_try_add_remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">do_add</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">do_add</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_add</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">spec</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_remove</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">spec</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_try_remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
        <span class="c1"># remove (a set of) particles</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;src:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">sublat</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">defect_sublattices</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;state = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">([</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="n">sublat</span><span class="o">.</span><span class="n">latgas_rep</span><span class="p">]))</span>

        <span class="n">groups</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;try_remove: groups=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">groups</span><span class="p">))</span>

        <span class="c1"># find sublattices which each species belongs to</span>
        <span class="c1"># sublats := [ (grp, cnt, [ sublat_id ]) ]</span>
        <span class="n">sublats</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="n">grp</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="p">[</span> <span class="n">sublat_id</span>
                                 <span class="k">for</span> <span class="n">sublat_id</span><span class="p">,</span> <span class="n">sublat</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">defect_sublattices</span><span class="p">)</span>
                                 <span class="k">if</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">sublat</span><span class="o">.</span><span class="n">group_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">])</span>
                    <span class="k">for</span> <span class="n">grp</span><span class="p">,</span> <span class="n">cnt</span> <span class="ow">in</span> <span class="n">groups</span> <span class="p">]</span>

        <span class="c1"># sublattice, and indexes of group and vacancy in latgas_rep</span>
        <span class="c1"># for each sublattice which each group belongs to</span>
        <span class="c1"># rep_table := [ (grp, cnt, [ (sublat_id, rep_index) ]) ]</span>
        <span class="n">rep_table</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">grp</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">sublat_ids</span> <span class="ow">in</span> <span class="n">sublats</span><span class="p">:</span>
            <span class="n">tbl</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">sublat_id</span> <span class="ow">in</span> <span class="n">sublat_ids</span><span class="p">:</span>
                <span class="n">lat</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">defect_sublattices</span><span class="p">[</span><span class="n">sublat_id</span><span class="p">]</span>
                <span class="n">idxs</span> <span class="o">=</span> <span class="n">match_latgas_group</span><span class="p">(</span><span class="n">lat</span><span class="o">.</span><span class="n">latgas_rep</span><span class="p">,</span> <span class="n">lat</span><span class="o">.</span><span class="n">group_dict</span><span class="p">[</span><span class="n">grp</span><span class="p">])</span>
                <span class="n">tbl</span> <span class="o">+=</span> <span class="p">[</span> <span class="p">(</span><span class="n">sublat_id</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">idxs</span> <span class="p">]</span>
            <span class="n">rep_table</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">grp</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">tbl</span><span class="p">)]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;try_remove: rep_table=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rep_table</span><span class="p">))</span>

        <span class="c1"># check if there are any choice</span>
        <span class="n">is_unremovable</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">tbl</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">cnt</span> <span class="k">for</span> <span class="n">grp</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">rep_table</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">is_unremovable</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;try_remove: there is no choice&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="p">{</span> <span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="s1">&#39;remove&#39;</span><span class="p">,</span> <span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="s1">&#39;nochoice&#39;</span><span class="p">,</span> <span class="s1">&#39;spec&#39;</span><span class="p">:</span> <span class="n">spec</span> <span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># choose sublattice and latgas_rep index</span>
        <span class="c1"># for each species and vacancy associated with the species</span>
        <span class="n">choice</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">grp</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">rep_table</span><span class="p">:</span>
            <span class="n">ch</span> <span class="o">=</span> <span class="p">[</span> <span class="n">tbl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">rand</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tbl</span><span class="p">),</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span> <span class="p">]</span>
            <span class="n">choice</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">grp</span><span class="p">,</span> <span class="n">ch</span><span class="p">)]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;try_remove: choice=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">choice</span><span class="p">))</span>

        <span class="c1"># update config</span>
        <span class="k">for</span> <span class="n">grp</span><span class="p">,</span> <span class="n">choices</span> <span class="ow">in</span> <span class="n">choice</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">choices</span><span class="p">:</span>
                <span class="n">sublat_id</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">ch</span>
                <span class="n">lat</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">defect_sublattices</span><span class="p">[</span><span class="n">sublat_id</span><span class="p">]</span>
                <span class="n">lat</span><span class="o">.</span><span class="n">latgas_rep</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">lat</span><span class="o">.</span><span class="n">vac_group</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;dst:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">sublat</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">defect_sublattices</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;state = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">([</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="n">sublat</span><span class="o">.</span><span class="n">latgas_rep</span><span class="p">]))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="p">{</span> <span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="s1">&#39;remove&#39;</span><span class="p">,</span> <span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="s1">&#39;ok&#39;</span><span class="p">,</span> <span class="s1">&#39;spec&#39;</span><span class="p">:</span> <span class="n">spec</span><span class="p">,</span> <span class="s1">&#39;choice&#39;</span><span class="p">:</span> <span class="n">choice</span> <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_try_add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
        <span class="c1"># add (a set of) particles</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;src:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">sublat</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">defect_sublattices</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">([</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="n">sublat</span><span class="o">.</span><span class="n">latgas_rep</span><span class="p">]))</span>

        <span class="n">groups</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;try_add: groups=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">groups</span><span class="p">))</span>

        <span class="c1"># find sublattices which each species belongs to</span>
        <span class="c1"># sublats := [ (grp, cnt, [ sublat_id ]) ]</span>
        <span class="n">sublats</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="n">grp</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="p">[</span> <span class="n">sublat_id</span>
                            <span class="k">for</span> <span class="n">sublat_id</span><span class="p">,</span> <span class="n">sublat</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">defect_sublattices</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">sublat</span><span class="o">.</span><span class="n">group_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">])</span>
                    <span class="k">for</span> <span class="n">grp</span><span class="p">,</span> <span class="n">cnt</span> <span class="ow">in</span> <span class="n">groups</span> <span class="p">]</span>

        <span class="c1"># sublattice, and indexes of group and vacancy in latgas_rep</span>
        <span class="c1"># for each sublattice which each group belongs to</span>
        <span class="c1"># rep_table := [ (grp, [ (sublat_id, rep_index) ]) ]</span>
        <span class="n">vac_table</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">grp</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">sublat_ids</span> <span class="ow">in</span> <span class="n">sublats</span><span class="p">:</span>
            <span class="n">tbl</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">sublat_id</span> <span class="ow">in</span> <span class="n">sublat_ids</span><span class="p">:</span>
                <span class="n">lat</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">defect_sublattices</span><span class="p">[</span><span class="n">sublat_id</span><span class="p">]</span>
                <span class="n">idxs</span> <span class="o">=</span> <span class="n">match_latgas_group</span><span class="p">(</span><span class="n">lat</span><span class="o">.</span><span class="n">latgas_rep</span><span class="p">,</span> <span class="n">lat</span><span class="o">.</span><span class="n">group_dict</span><span class="p">[</span><span class="n">lat</span><span class="o">.</span><span class="n">vac_group</span><span class="p">])</span>
                <span class="n">tbl</span> <span class="o">+=</span> <span class="p">[</span> <span class="p">(</span><span class="n">sublat_id</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">idxs</span> <span class="p">]</span>
            <span class="n">vac_table</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">grp</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">tbl</span><span class="p">)]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;try_add: vac_table=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">vac_table</span><span class="p">))</span>

        <span class="c1"># check if there are any choice</span>
        <span class="n">is_unaddable</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">tbl</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">cnt</span> <span class="k">for</span> <span class="n">grp</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">vac_table</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">is_unaddable</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;try_add: there is no choice&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="p">{</span> <span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="s1">&#39;nochoice&#39;</span><span class="p">,</span> <span class="s1">&#39;spec&#39;</span><span class="p">:</span> <span class="n">spec</span> <span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># number of species</span>
        <span class="n">nspecies</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sublats</span><span class="p">)</span>

        <span class="c1"># number of sublattices to which any of species belong to</span>
        <span class="n">nsublat</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">sum</span><span class="p">([</span> <span class="n">sublat_ids</span> <span class="k">for</span> <span class="n">grp</span><span class="p">,</span><span class="n">cnt</span><span class="p">,</span><span class="n">sublat_ids</span> <span class="ow">in</span> <span class="n">sublats</span> <span class="p">],</span> <span class="p">[])))</span>

        <span class="c1"># sublattices of each species are disjoint or not</span>
        <span class="n">is_disjoint</span> <span class="o">=</span> <span class="nb">all</span><span class="p">([</span> <span class="nb">set</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">==</span> <span class="nb">set</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">sublats</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="p">])</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;try_add: nspecies=</span><span class="si">{}</span><span class="s2">, nsublat=</span><span class="si">{}</span><span class="s2">, is_disjoint=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nspecies</span><span class="p">,</span> <span class="n">nsublat</span><span class="p">,</span> <span class="n">is_disjoint</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">nspecies</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># there is only one species: no conflict</span>
            <span class="n">choice</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">grp</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">vac_table</span><span class="p">:</span>
                <span class="n">ch</span> <span class="o">=</span> <span class="p">[</span> <span class="n">tbl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">rand</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tbl</span><span class="p">),</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span> <span class="p">]</span>
                <span class="n">choice</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">grp</span><span class="p">,</span> <span class="n">ch</span><span class="p">)]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;try_add: nspecies=1 branch. choice=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">choice</span><span class="p">))</span>

        <span class="k">elif</span> <span class="n">nsublat</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># if there is one sublattice accommodating all species of concern,</span>
            <span class="c1"># set of vacancies for each species is identical.</span>

            <span class="c1"># assert identical</span>
            <span class="k">assert</span><span class="p">(</span><span class="nb">all</span><span class="p">([</span> <span class="nb">set</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">vac_table</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="p">]))</span>

            <span class="n">vac_list</span> <span class="o">=</span> <span class="n">vac_table</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>

            <span class="n">nelem</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">j</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">])</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vac_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">nelem</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;try_add: nsublat=1, there is no choice&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="p">{</span> <span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="s1">&#39;nochoice&#39;</span><span class="p">,</span> <span class="s1">&#39;spec&#39;</span><span class="p">:</span> <span class="n">spec</span> <span class="p">}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>

            <span class="n">ch</span> <span class="o">=</span> <span class="n">rand</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vac_list</span><span class="p">),</span> <span class="n">nelem</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;&gt;&gt;&gt; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ch</span><span class="p">))</span>

            <span class="n">choice</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">ix</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">grp</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">vac_table</span><span class="p">:</span>
                <span class="n">choice</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">grp</span><span class="p">,</span> <span class="p">[</span> <span class="n">tbl</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ch</span><span class="p">[</span><span class="n">ix</span><span class="p">:</span><span class="n">ix</span><span class="o">+</span><span class="n">cnt</span><span class="p">]</span> <span class="p">])]</span>
                <span class="n">ix</span> <span class="o">+=</span> <span class="n">cnt</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;try_add: nsublat=1 branch. choice=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">choice</span><span class="p">))</span>

        <span class="k">elif</span> <span class="n">is_disjoint</span><span class="p">:</span>
            <span class="c1"># if sublattices of each species are disjoint, may choose independently</span>
            <span class="n">choice</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">grp</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">vac_table</span><span class="p">:</span>
                <span class="n">ch</span> <span class="o">=</span> <span class="p">[</span> <span class="n">tbl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">rand</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tbl</span><span class="p">),</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span> <span class="p">]</span>
                <span class="n">choice</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">grp</span><span class="p">,</span> <span class="n">ch</span><span class="p">)]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;try_add: is_disjoint branch. choice=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">choice</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># general case. retry until consistent choice is made</span>
            <span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">max_retry</span> <span class="o">=</span> <span class="mi">5</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1"># choose sublattice and latgas_rep index</span>
                <span class="c1"># for each species and vacancy associated with the species</span>
                <span class="n">choice</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">grp</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">vac_table</span><span class="p">:</span>
                    <span class="n">ch</span> <span class="o">=</span> <span class="p">[</span> <span class="n">tbl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">rand</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tbl</span><span class="p">),</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span> <span class="p">]</span>
                    <span class="n">choice</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">grp</span><span class="p">,</span> <span class="n">ch</span><span class="p">)]</span>

                <span class="c1"># check consistency</span>
                <span class="n">is_nodup</span> <span class="o">=</span> <span class="nb">all</span><span class="p">([</span> <span class="nb">set</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="nb">set</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">choice</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="p">])</span>
                <span class="k">if</span> <span class="n">is_nodup</span><span class="p">:</span>
                    <span class="k">break</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;try_add: duplicated. retry. choice=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">choice</span><span class="p">))</span>

                <span class="n">retry</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">retry</span> <span class="o">&gt;=</span> <span class="n">max_retry</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;try_add: no choice. quit&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="p">{</span> <span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="s1">&#39;dup&#39;</span><span class="p">,</span> <span class="s1">&#39;spec&#39;</span><span class="p">:</span> <span class="n">spec</span> <span class="p">}</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">False</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;try_add: general branch. choice=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">choice</span><span class="p">))</span>

        <span class="c1"># update config</span>
        <span class="k">for</span> <span class="n">grp</span><span class="p">,</span> <span class="n">choices</span> <span class="ow">in</span> <span class="n">choice</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">choices</span><span class="p">:</span>
                <span class="n">sublat_id</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">ch</span>
                <span class="n">lat</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">defect_sublattices</span><span class="p">[</span><span class="n">sublat_id</span><span class="p">]</span>
                <span class="n">lat</span><span class="o">.</span><span class="n">latgas_rep</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">grp</span><span class="p">,</span> <span class="n">rand</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">lat</span><span class="o">.</span><span class="n">group_dict</span><span class="p">[</span><span class="n">grp</span><span class="p">]</span><span class="o">.</span><span class="n">orientations</span><span class="p">)]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;dst:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">sublat</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">defect_sublattices</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">([</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="n">sublat</span><span class="o">.</span><span class="n">latgas_rep</span><span class="p">]))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="p">{</span> <span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="s1">&#39;ok&#39;</span><span class="p">,</span> <span class="s1">&#39;spec&#39;</span><span class="p">:</span> <span class="n">spec</span><span class="p">,</span> <span class="s1">&#39;choice&#39;</span><span class="p">:</span> <span class="n">choice</span> <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_try_replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
        <span class="c1"># replace set of particles to another set</span>
        <span class="c1"># single species version, i.e. A -&gt; B</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;src:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">sublat</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">defect_sublattices</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">([</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="n">sublat</span><span class="o">.</span><span class="n">latgas_rep</span><span class="p">]))</span>

        <span class="n">sp_from</span><span class="p">,</span> <span class="n">sp_to</span> <span class="o">=</span> <span class="n">spec</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;try_replace: groups from=</span><span class="si">{}</span><span class="s2">, to=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sp_from</span><span class="p">,</span> <span class="n">sp_to</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">_sum</span><span class="p">(</span><span class="n">xs</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">j</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="n">xs</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">_sum</span><span class="p">(</span><span class="n">sp_from</span><span class="p">)</span> <span class="o">!=</span> <span class="n">_sum</span><span class="p">(</span><span class="n">sp_to</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;try_replace: supports only from single species to single species case&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="p">{</span> <span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="s1">&#39;replace&#39;</span><span class="p">,</span> <span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="s1">&#39;unsupported&#39;</span><span class="p">,</span> <span class="s1">&#39;spec&#39;</span><span class="p">:</span> <span class="n">spec</span> <span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># find sublattices which each species belongs to</span>
        <span class="c1"># sublats := [ (grp, cnt, [ sublat_id ]) ]</span>
        <span class="n">sublats</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="n">grp</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="p">[</span> <span class="n">sublat_id</span>
                                 <span class="k">for</span> <span class="n">sublat_id</span><span class="p">,</span> <span class="n">sublat</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">defect_sublattices</span><span class="p">)</span>
                                 <span class="k">if</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">sublat</span><span class="o">.</span><span class="n">group_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">])</span>
                    <span class="k">for</span> <span class="n">grp</span><span class="p">,</span><span class="n">cnt</span> <span class="ow">in</span> <span class="n">sp_from</span> <span class="p">]</span>

        <span class="c1"># sublattice, and indexes of group and vacancy in latgas_rep</span>
        <span class="c1"># for each sublattice which each group belongs to</span>
        <span class="c1"># rep_table := [ (grp, cnt, [ (sublat_id, rep_index) ]) ]</span>
        <span class="n">rep_table</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">grp</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">sublat_ids</span> <span class="ow">in</span> <span class="n">sublats</span><span class="p">:</span>
            <span class="n">tbl</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">sublat_id</span> <span class="ow">in</span> <span class="n">sublat_ids</span><span class="p">:</span>
                <span class="n">lat</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">defect_sublattices</span><span class="p">[</span><span class="n">sublat_id</span><span class="p">]</span>
                <span class="n">idxs</span> <span class="o">=</span> <span class="n">match_latgas_group</span><span class="p">(</span><span class="n">lat</span><span class="o">.</span><span class="n">latgas_rep</span><span class="p">,</span> <span class="n">lat</span><span class="o">.</span><span class="n">group_dict</span><span class="p">[</span><span class="n">grp</span><span class="p">])</span>
                <span class="n">tbl</span> <span class="o">+=</span> <span class="p">[</span> <span class="p">(</span><span class="n">sublat_id</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">idxs</span> <span class="p">]</span>
            <span class="n">rep_table</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">grp</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">tbl</span><span class="p">)]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;try_replace: rep_table=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rep_table</span><span class="p">))</span>

        <span class="c1"># check if there are any choice</span>
        <span class="n">is_unremovable</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">tbl</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">cnt</span> <span class="k">for</span> <span class="n">grp</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">rep_table</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">is_unremovable</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;try_replace: there is no choice&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="p">{</span> <span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="s1">&#39;replace&#39;</span><span class="p">,</span> <span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="s1">&#39;nochoice&#39;</span><span class="p">,</span> <span class="s1">&#39;spec&#39;</span><span class="p">:</span> <span class="n">spec</span> <span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># choose sublattice and latgas_rep index</span>
        <span class="c1"># for each species and vacancy associated with the species</span>
        <span class="n">choice</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">grp</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">rep_table</span><span class="p">:</span>
            <span class="n">ch</span> <span class="o">=</span> <span class="p">[</span> <span class="n">tbl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">rand</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tbl</span><span class="p">),</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span> <span class="p">]</span>
            <span class="n">choice</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">grp</span><span class="p">,</span> <span class="n">ch</span><span class="p">)]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;try_replace: choice=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">choice</span><span class="p">))</span>

        <span class="c1"># assign new groups to vacant places</span>
        <span class="n">new_vac</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">ch</span> <span class="k">for</span> <span class="n">grp</span><span class="p">,</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">choice</span><span class="p">],</span> <span class="p">[])</span>
        <span class="n">new_vac_shuffle</span> <span class="o">=</span> <span class="n">rand</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">new_vac</span><span class="p">)</span>

        <span class="n">group_assign</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ix</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">grp</span><span class="p">,</span> <span class="n">cnt</span> <span class="ow">in</span> <span class="n">sp_to</span><span class="p">:</span>
            <span class="n">group_assign</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">grp</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">new_vac_shuffle</span><span class="p">[</span><span class="n">ix</span><span class="p">:</span><span class="n">ix</span><span class="o">+</span><span class="n">cnt</span><span class="p">])]</span>
            <span class="n">ix</span> <span class="o">+=</span> <span class="n">cnt</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;try_replace: assign=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">group_assign</span><span class="p">))</span>

        <span class="c1"># check if choice is valid</span>
        <span class="n">noassign</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">newgrp</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">choices</span> <span class="ow">in</span> <span class="n">group_assign</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">choices</span><span class="p">:</span>
                <span class="n">sublat_id</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">ch</span>
                <span class="k">if</span> <span class="n">newgrp</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">defect_sublattices</span><span class="p">[</span><span class="n">sublat_id</span><span class="p">]</span><span class="o">.</span><span class="n">group_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">noassign</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
        <span class="k">if</span> <span class="n">noassign</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;try_replace: assignment not satisfied&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="p">{</span> <span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="s1">&#39;replace&#39;</span><span class="p">,</span> <span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="s1">&#39;noassign&#39;</span><span class="p">,</span> <span class="s1">&#39;spec&#39;</span><span class="p">:</span> <span class="n">spec</span> <span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># update config</span>
        <span class="k">for</span> <span class="n">newgrp</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">choices</span> <span class="ow">in</span> <span class="n">group_assign</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">choices</span><span class="p">:</span>
                <span class="n">sublat_id</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">ch</span>
                <span class="n">lat</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">defect_sublattices</span><span class="p">[</span><span class="n">sublat_id</span><span class="p">]</span>
                <span class="n">lat</span><span class="o">.</span><span class="n">latgas_rep</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">newgrp</span><span class="p">,</span> <span class="n">rand</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">lat</span><span class="o">.</span><span class="n">group_dict</span><span class="p">[</span><span class="n">newgrp</span><span class="p">]</span><span class="o">.</span><span class="n">orientations</span><span class="p">)]</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;dst:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">sublat</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">defect_sublattices</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">([</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="n">sublat</span><span class="o">.</span><span class="n">latgas_rep</span><span class="p">]))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="p">{</span> <span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="s1">&#39;replace&#39;</span><span class="p">,</span> <span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="s1">&#39;ok&#39;</span><span class="p">,</span> <span class="s1">&#39;spec&#39;</span><span class="p">:</span> <span class="n">spec</span><span class="p">,</span> <span class="s1">&#39;choice&#39;</span><span class="p">:</span> <span class="n">choice</span> <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

<div class="viewcode-block" id="DFTLatticeGas.trialstep"><a class="viewcode-back" href="../../../../abics.applications.latgas_abinitio_interface.model_setup.html#abics.applications.latgas_abinitio_interface.model_setup.DFTLatticeGas.trialstep">[docs]</a>    <span class="k">def</span> <span class="nf">trialstep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">energy_now</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        config: config object</span>
<span class="sd">            Configurations</span>
<span class="sd">        energy_now: float</span>
<span class="sd">            Present energy</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dconfig: float</span>
<span class="sd">            Difference of configurations</span>
<span class="sd">        dE : float</span>
<span class="sd">            Difference of energies</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;&gt;&gt;&gt; start trialstep&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_grandcanonical</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">chemical_potential</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="s2">&quot;chemical potential missing&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">subl</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">defect_sublattices</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;state = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">([</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">subl</span><span class="o">.</span><span class="n">latgas_rep</span> <span class="p">]))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;energy = </span><span class="si">{:16.12e}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">energy_now</span><span class="p">))</span>

        <span class="n">e0</span> <span class="o">=</span> <span class="n">energy_now</span>
        <span class="n">old_internal_energy</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">internal_energy</span>
        <span class="n">old_energy</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">energy</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_grandcanonical</span><span class="p">:</span>
            <span class="c1"># w0 = self._calc_weight(config)</span>
            <span class="n">numvec0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_num_group_list</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

        <span class="c1"># Back up structure and defect_sublattices</span>
        <span class="n">structure0</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span>
        <span class="n">structure_norel0</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">structure_norel</span><span class="p">)</span>
        <span class="n">defect_sublattices0</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">defect_sublattices</span><span class="p">)</span>

        <span class="n">nretry</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># for defect_sublattice in [rand.choice(config.defect_sublattices)]: #config.defect_sublattices:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;=== trial </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nretry</span><span class="p">))</span>
            <span class="n">nretry</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1"># print(latgas_rep)</span>

            <span class="n">trial</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">trial_info</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_grandcanonical</span> <span class="ow">or</span> <span class="n">rand</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gc_ratio</span><span class="p">:</span>
                <span class="c1"># canonical move</span>

                <span class="c1"># If there is more than one group on the defect_sublattice,</span>
                <span class="c1"># we either change orientation of one group, or  exchange groups between sites</span>

                <span class="n">defect_sublattice</span> <span class="o">=</span> <span class="n">rand</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">defect_sublattices</span><span class="p">)</span>
                <span class="c1">#latgas_rep = defect_sublattice.latgas_rep</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">defect_sublattices</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="n">defect_sublattice</span><span class="p">:</span>
                            <span class="n">sublat_id</span> <span class="o">=</span> <span class="n">i</span>
                            <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">sublat_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;sublattice id not found&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">defect_sublattice</span><span class="o">.</span><span class="n">groups</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;trialstep: try rotate only&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                        <span class="n">trial</span><span class="p">,</span> <span class="n">trial_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_rotate</span><span class="p">(</span><span class="n">defect_sublattice</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">trial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_rotate</span><span class="p">(</span><span class="n">defect_sublattice</span><span class="p">)</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">defect_sublattice</span><span class="o">.</span><span class="n">groups_orr</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;trialstep: try exchange only&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                        <span class="n">trial</span><span class="p">,</span> <span class="n">trial_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_exchange</span><span class="p">(</span><span class="n">defect_sublattice</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">trial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_exchange</span><span class="p">(</span><span class="n">defect_sublattice</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">rand</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;trialstep: try rotate&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                            <span class="n">trial</span><span class="p">,</span> <span class="n">trial_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_rotate</span><span class="p">(</span><span class="n">defect_sublattice</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">trial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_rotate</span><span class="p">(</span><span class="n">defect_sublattice</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;trialstep: try exchange&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                            <span class="n">trial</span><span class="p">,</span> <span class="n">trial_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_exchange</span><span class="p">(</span><span class="n">defect_sublattice</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">trial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_exchange</span><span class="p">(</span><span class="n">defect_sublattice</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                    <span class="n">trial_info</span><span class="p">[</span><span class="s1">&#39;sublat_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sublat_id</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># grandcanonical move</span>

                <span class="c1"># choose a move</span>
                <span class="n">move_id</span> <span class="o">=</span> <span class="n">rand</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">gc_move</span><span class="p">))</span>
                <span class="n">move</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">gc_move</span><span class="p">[</span><span class="n">move_id</span><span class="p">]</span>
                <span class="n">do_forward</span> <span class="o">=</span> <span class="p">(</span><span class="n">move</span><span class="p">[</span><span class="s1">&#39;reverse&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">rand</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">)</span>

                <span class="n">spec</span> <span class="o">=</span> <span class="p">(</span><span class="n">move</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">],</span><span class="n">move</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="n">do_forward</span> <span class="k">else</span> <span class="p">(</span><span class="n">move</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">],</span><span class="n">move</span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">])</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># [] - &gt;[A,..]</span>
                    <span class="n">trial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_add</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">spec</span><span class="p">)</span>

                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># [A,..] -&gt; []</span>
                    <span class="n">trial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_remove</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">spec</span><span class="p">)</span>

                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">spec</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="c1"># [A] -&gt; [B]</span>
                    <span class="n">trial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_replace</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">spec</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># most general case: to be implemented</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;unsupported move&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                    <span class="n">trial</span><span class="p">,</span> <span class="n">trial_info</span> <span class="o">=</span> <span class="n">trial</span>

            <span class="k">if</span> <span class="n">trial</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="c1">#- retry</span>
                <span class="c1"># continue</span>
                <span class="c1">#- do not retry. let it be rejected</span>
                <span class="k">break</span>

            <span class="c1"># print(latgas_rep)</span>
            <span class="n">constraint_fulfilled</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">set_latgas</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">constraint_fulfilled</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># restore from backup and retry</span>
                <span class="n">config</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">structure0</span><span class="p">)</span>
                <span class="n">config</span><span class="o">.</span><span class="n">defect_sublattices</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">defect_sublattices0</span><span class="p">)</span>
                <span class="k">continue</span>

        <span class="k">if</span> <span class="n">trial</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># do vasp calculation on structure</span>
            <span class="n">new_internal_energy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_energy</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_grandcanonical</span><span class="p">:</span>
                <span class="n">new_energy</span> <span class="o">=</span> <span class="n">new_internal_energy</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_muN_term</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
                <span class="n">numvec1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_num_group_list</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
                <span class="n">dW</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_dweight</span><span class="p">(</span><span class="n">numvec0</span><span class="p">,</span> <span class="n">numvec1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_energy</span> <span class="o">=</span> <span class="n">new_internal_energy</span>
                <span class="n">dW</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># nominal value</span>
            <span class="n">new_internal_energy</span> <span class="o">=</span> <span class="n">old_internal_energy</span>
            <span class="n">new_energy</span> <span class="o">=</span> <span class="n">old_energy</span>
            <span class="n">dW</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;nan&quot;</span><span class="p">)</span>

        <span class="c1"># return old structure</span>
        <span class="n">structure</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">structure</span>
        <span class="n">structure_norel</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">structure_norel</span>
        <span class="n">config</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="n">structure0</span>
        <span class="n">config</span><span class="o">.</span><span class="n">structure_norel</span> <span class="o">=</span> <span class="n">structure_norel0</span>
        <span class="n">defect_sublattices</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">defect_sublattices</span>
        <span class="n">config</span><span class="o">.</span><span class="n">defect_sublattices</span> <span class="o">=</span> <span class="n">defect_sublattices0</span>

        <span class="c1"># Simply pass new structure and latgas_rep  in dconfig to be used by newconfig():</span>
        <span class="n">dconfig</span> <span class="o">=</span> <span class="n">structure</span><span class="p">,</span> <span class="n">structure_norel</span><span class="p">,</span> <span class="n">defect_sublattices</span><span class="p">,</span> <span class="n">new_energy</span><span class="p">,</span> <span class="n">new_internal_energy</span>
        <span class="k">if</span> <span class="n">e0</span> <span class="o">==</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">):</span>
            <span class="n">dE</span> <span class="o">=</span> <span class="n">new_energy</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dE</span> <span class="o">=</span> <span class="n">new_energy</span> <span class="o">-</span> <span class="n">old_energy</span>

        <span class="k">for</span> <span class="n">subl</span> <span class="ow">in</span> <span class="n">defect_sublattices</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;state = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">([</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">subl</span><span class="o">.</span><span class="n">latgas_rep</span> <span class="p">]))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;energy = </span><span class="si">{:16.12f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_energy</span><span class="p">))</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;trialstep: dE=</span><span class="si">{:16.12e}</span><span class="s2">, dW=</span><span class="si">{:.5e}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dE</span><span class="p">,</span> <span class="n">dW</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;&lt;&lt;&lt; end trialstep&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_grandcanonical</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">dconfig</span><span class="p">,</span> <span class="n">dE</span><span class="p">,</span> <span class="n">dW</span><span class="p">,</span> <span class="n">trial_info</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">dconfig</span><span class="p">,</span> <span class="n">dE</span><span class="p">,</span> <span class="n">dW</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">dconfig</span><span class="p">,</span> <span class="n">dE</span><span class="p">,</span> <span class="n">trial_info</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">dconfig</span><span class="p">,</span> <span class="n">dE</span></div>


<div class="viewcode-block" id="DFTLatticeGas.newconfig"><a class="viewcode-back" href="../../../../abics.applications.latgas_abinitio_interface.model_setup.html#abics.applications.latgas_abinitio_interface.model_setup.DFTLatticeGas.newconfig">[docs]</a>    <span class="k">def</span> <span class="nf">newconfig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">dconfig</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update config by the trial step, dconfig</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        config: config object</span>
<span class="sd">            Configuration</span>
<span class="sd">        dconfig: config object</span>
<span class="sd">            Difference of configuration</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        config: config object</span>
<span class="sd">            New configuration</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">config</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">structure_norel</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">defect_sublattices</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">energy</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">internal_energy</span> <span class="o">=</span> <span class="n">dconfig</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_update_basestruct</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_basestruct</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">config</span></div></div>


<div class="viewcode-block" id="EnergyList"><a class="viewcode-back" href="../../../../abics.applications.latgas_abinitio_interface.model_setup.html#abics.applications.latgas_abinitio_interface.model_setup.EnergyList">[docs]</a><span class="k">class</span> <span class="nc">EnergyList</span><span class="p">(</span><span class="n">DFTLatticeGas</span><span class="p">):</span>
<div class="viewcode-block" id="EnergyList.__init__"><a class="viewcode-back" href="../../../../abics.applications.latgas_abinitio_interface.model_setup.html#abics.applications.latgas_abinitio_interface.model_setup.EnergyList.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">calcode</span><span class="p">,</span>
        <span class="n">vasp_run</span><span class="p">,</span>
        <span class="n">base_vaspinput</span><span class="p">,</span>
        <span class="n">matcher_base</span><span class="p">,</span>  <span class="c1"># matcher, matcher_site,</span>
        <span class="n">queen</span><span class="p">,</span>
        <span class="n">reps</span><span class="p">,</span>
        <span class="n">energy_lst</span><span class="p">,</span>
        <span class="n">matcher</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        calcode:</span>
<span class="sd">        vasp_run: runner object</span>
<span class="sd">            Runner (manager) of external solver program</span>
<span class="sd">        base_vaspinput:</span>
<span class="sd">        matcher_base:</span>
<span class="sd">        queen:</span>
<span class="sd">        reps:</span>
<span class="sd">        energy_lst: list</span>
<span class="sd">            Energy list</span>
<span class="sd">        matcher:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">calcode</span><span class="p">,</span>
            <span class="n">vasp_run</span><span class="p">,</span>
            <span class="n">base_vaspinput</span><span class="p">,</span>
            <span class="n">matcher_base</span><span class="p">,</span>  <span class="c1"># matcher, matcher_site,</span>
            <span class="n">queen</span><span class="p">,</span>
            <span class="n">matcher</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reps</span> <span class="o">=</span> <span class="n">reps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">energy_list</span> <span class="o">=</span> <span class="n">energy_lst</span></div>

<div class="viewcode-block" id="EnergyList.energy"><a class="viewcode-back" href="../../../../abics.applications.latgas_abinitio_interface.model_setup.html#abics.applications.latgas_abinitio_interface.model_setup.EnergyList.energy">[docs]</a>    <span class="k">def</span> <span class="nf">energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">save_history</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        config: config object</span>
<span class="sd">            Configuration</span>
<span class="sd">        save_history: boolean</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        energy: float</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rep_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reps</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">latgas_rep</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">energy_list</span><span class="p">[</span><span class="n">rep_id</span><span class="p">])</span></div></div>


<div class="viewcode-block" id="Group"><a class="viewcode-back" href="../../../../abics.applications.latgas_abinitio_interface.model_setup.html#abics.applications.latgas_abinitio_interface.model_setup.Group">[docs]</a><span class="k">class</span> <span class="nc">Group</span><span class="p">:</span>
<div class="viewcode-block" id="Group.__init__"><a class="viewcode-back" href="../../../../abics.applications.latgas_abinitio_interface.model_setup.html#abics.applications.latgas_abinitio_interface.model_setup.Group.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">relaxations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">magnetizations</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name: str</span>
<span class="sd">            The name of atomic group</span>
<span class="sd">        species: list of str</span>
<span class="sd">            The atomic species belonging to the atom group</span>
<span class="sd">        coords: numpy array</span>
<span class="sd">            The coordinates of each atom in the atom group.</span>
<span class="sd">        relaxations: numpy array</span>
<span class="sd">            Whether to perform structure optimization or not</span>
<span class="sd">        magnetization: numpy array</span>
<span class="sd">            Magnetizations (inbalance of up/down spins)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species</span> <span class="o">=</span> <span class="n">species</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span> <span class="k">if</span> <span class="n">coords</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relaxations</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">relaxations</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">relaxations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">magnetizations</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">magnetizations</span><span class="p">)</span> <span class="k">if</span> <span class="n">magnetizations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orientations</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">orientations</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">orientations</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">natoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">species</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="DefectSublattice"><a class="viewcode-back" href="../../../../abics.applications.latgas_abinitio_interface.model_setup.html#abics.applications.latgas_abinitio_interface.model_setup.DefectSublattice">[docs]</a><span class="k">class</span> <span class="nc">DefectSublattice</span><span class="p">:</span>
<div class="viewcode-block" id="DefectSublattice.__init__"><a class="viewcode-back" href="../../../../abics.applications.latgas_abinitio_interface.model_setup.html#abics.applications.latgas_abinitio_interface.model_setup.DefectSublattice.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">site_centers</span><span class="p">,</span> <span class="n">groups</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        site_centers: list</span>
<span class="sd">            Center coordinates at each groups</span>
<span class="sd">        groups: list</span>
<span class="sd">            List of groups</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">site_centers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">site_centers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">groups</span> <span class="o">=</span> <span class="n">groups</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">groups_orr</span> <span class="o">=</span> <span class="p">[</span> <span class="n">group</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span> <span class="k">if</span> <span class="n">group</span><span class="o">.</span><span class="n">orientations</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group_dict</span> <span class="o">=</span> <span class="p">{</span> <span class="n">group</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">group</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span> <span class="p">}</span></div>

<div class="viewcode-block" id="DefectSublattice.from_dict"><a class="viewcode-back" href="../../../../abics.applications.latgas_abinitio_interface.model_setup.html#abics.applications.latgas_abinitio_interface.model_setup.DefectSublattice.from_dict">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;DefectSublattice&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        d: dict</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        site_centers: list</span>
<span class="sd">            Center coordinates at each groups</span>
<span class="sd">        groups: list</span>
<span class="sd">            List of groups</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">site_centers</span> <span class="o">=</span> <span class="n">read_matrix</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;coords&quot;</span><span class="p">])</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;groups&quot;</span><span class="p">]:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="n">species</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;species&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">name</span><span class="p">])</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">species</span><span class="p">)</span>

            <span class="n">coords</span> <span class="o">=</span> <span class="n">read_tensor</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;coords&quot;</span><span class="p">,</span> <span class="p">[[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]]),</span> <span class="n">rank</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">m</span> <span class="o">!=</span> <span class="n">n</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span>
                    <span class="s1">&#39;number of atoms mismatch in group [</span><span class="si">{}</span><span class="s1">]: &quot;species&quot;=</span><span class="si">{}</span><span class="s1">, &quot;coords&quot;=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">name</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="n">relaxation</span> <span class="o">=</span> <span class="n">read_matrix</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;relaxation&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="mi">3</span><span class="p">))),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">relaxation</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">m</span> <span class="o">!=</span> <span class="n">n</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span>
                    <span class="s1">&#39;number of atoms mismatch in group [</span><span class="si">{}</span><span class="s1">]: &quot;species&quot;=</span><span class="si">{}</span><span class="s1">, &quot;relaxation&quot;=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">name</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="n">mag</span> <span class="o">=</span> <span class="n">read_vector</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;magnetization&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)))</span>
            <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mag</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">m</span> <span class="o">!=</span> <span class="n">n</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span>
                    <span class="s1">&#39;number of atoms mismatch in group [</span><span class="si">{}</span><span class="s1">]: &quot;species&quot;=</span><span class="si">{}</span><span class="s1">, &quot;magnetization&quot;=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">name</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="n">groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">Group</span><span class="p">(</span>
                    <span class="n">name</span><span class="p">,</span>
                    <span class="n">species</span><span class="p">,</span>
                    <span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span>
                    <span class="n">relaxations</span><span class="o">=</span><span class="n">relaxation</span><span class="p">,</span>
                    <span class="n">magnetizations</span><span class="o">=</span><span class="n">mag</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">site_centers</span><span class="p">,</span> <span class="n">groups</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="base_structure"><a class="viewcode-back" href="../../../../abics.applications.latgas_abinitio_interface.model_setup.html#abics.applications.latgas_abinitio_interface.model_setup.base_structure">[docs]</a><span class="k">def</span> <span class="nf">base_structure</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">dict_str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Structure</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lat: pymatgen.Lattice</span>
<span class="sd">    dict_str: dict</span>
<span class="sd">        Dictionary of base structure</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    st: pymatgen.Structure</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dict_str</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dict_str</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">Structure</span><span class="p">(</span>
            <span class="n">lattice</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span>
            <span class="n">species</span><span class="o">=</span><span class="p">[],</span>
            <span class="n">coords</span><span class="o">=</span><span class="p">[],</span>
            <span class="n">site_properties</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;seldyn&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">),</span>
                <span class="s2">&quot;magnetization&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
            <span class="p">},</span>
        <span class="p">)</span>
    <span class="n">elems</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">relaxations</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">magnetizations</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">dict_str</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;type&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="s1">&#39;&quot;type&quot; is not found in &quot;base_structure&quot;&#39;</span><span class="p">)</span>
        <span class="n">sp</span> <span class="o">=</span> <span class="n">tc</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>
        <span class="n">crds</span> <span class="o">=</span> <span class="n">read_matrix</span><span class="p">(</span><span class="n">tc</span><span class="p">[</span><span class="s2">&quot;coords&quot;</span><span class="p">])</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">crds</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;relaxation&quot;</span> <span class="ow">in</span> <span class="n">tc</span><span class="p">:</span>
            <span class="n">relax</span> <span class="o">=</span> <span class="n">read_matrix</span><span class="p">(</span><span class="n">tc</span><span class="p">[</span><span class="s2">&quot;relaxation&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">relax</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">m</span> <span class="o">!=</span> <span class="n">n</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span>
                    <span class="s1">&#39;number of base atoms mismatch: &quot;coords&quot;=</span><span class="si">{}</span><span class="s1">, &quot;relaxation&quot;=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">n</span><span class="p">,</span> <span class="n">m</span>
                    <span class="p">)</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">relax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>  <span class="c1"># all True</span>

        <span class="k">if</span> <span class="s2">&quot;magnetization&quot;</span> <span class="ow">in</span> <span class="n">tc</span><span class="p">:</span>
            <span class="n">mag</span> <span class="o">=</span> <span class="n">tc</span><span class="p">[</span><span class="s2">&quot;magnetization&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mag</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="s1">&#39;&quot;magnetization&quot; should be a list of floats&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">mag</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mag</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span><span class="s1">&#39;&quot;magnetization&quot; should be a list of floats&#39;</span><span class="p">)</span>
            <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mag</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">m</span> <span class="o">!=</span> <span class="n">n</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span>
                    <span class="s1">&#39;number of base atoms mismatch: &quot;coords&quot;=</span><span class="si">{}</span><span class="s1">, &quot;magnetization&quot;=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">n</span><span class="p">,</span> <span class="n">m</span>
                    <span class="p">)</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

        <span class="n">elems</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">sp</span><span class="p">]</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span>
        <span class="n">coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">crds</span><span class="p">)</span>
        <span class="n">relaxations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">relax</span><span class="p">)</span>
        <span class="n">magnetizations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mag</span><span class="p">)</span>
    <span class="n">elems</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">elems</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">relaxations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">relaxations</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">magnetizations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">magnetizations</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Structure</span><span class="p">(</span>
        <span class="n">lattice</span><span class="o">=</span><span class="n">lat</span><span class="p">,</span>
        <span class="n">species</span><span class="o">=</span><span class="n">elems</span><span class="p">,</span>
        <span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span>
        <span class="n">site_properties</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;seldyn&quot;</span><span class="p">:</span> <span class="n">relaxations</span><span class="p">,</span> <span class="s2">&quot;magnetization&quot;</span><span class="p">:</span> <span class="n">magnetizations</span><span class="p">},</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="Config"><a class="viewcode-back" href="../../../../abics.applications.latgas_abinitio_interface.model_setup.html#abics.applications.latgas_abinitio_interface.model_setup.Config">[docs]</a><span class="k">class</span> <span class="nc">Config</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This class defines the config with lattice gas mapping&quot;&quot;&quot;</span>

<div class="viewcode-block" id="Config.__init__"><a class="viewcode-back" href="../../../../abics.applications.latgas_abinitio_interface.model_setup.html#abics.applications.latgas_abinitio_interface.model_setup.Config.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">base_structure</span><span class="p">:</span> <span class="n">Structure</span><span class="p">,</span>
        <span class="n">defect_sublattices</span><span class="p">,</span>
        <span class="n">num_defects</span><span class="p">,</span>
        <span class="n">cellsize</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
        <span class="n">constraint_func</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span>
        <span class="n">constraint_energy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">perfect_structure</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">chemical_potential</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">gc_move</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        base_structure : pymatgen.Structure</span>
<span class="sd">            Structure of base sites (unsampled sites)</span>
<span class="sd">        defect_sublattices : defect_sublattice</span>
<span class="sd">            Structure of defects (sampled sites)</span>
<span class="sd">        num_defects : dict</span>
<span class="sd">            {group name: number of defects}</span>
<span class="sd">        cellsize : list, optional</span>
<span class="sd">            Cell size, by default [1, 1, 1]</span>
<span class="sd">        constraint_func : function, optional</span>
<span class="sd">            function that takes pymatgen.Structure as argument and returns True</span>
<span class="sd">            when constraints are satisfied, by default bool</span>
<span class="sd">        perfect_structure : pymatgen.Structure, optional</span>
<span class="sd">            Strucure of all sites (union of base and defect), by default None</span>
<span class="sd">        chemical_potential : dict</span>
<span class="sd">            { tuple of species names: chemical potential }</span>
<span class="sd">        gc_move : list</span>
<span class="sd">            grandcanonical moves: { species from, species to, reversible }</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">num_defect_sublat</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">defect_sublattices</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">num_defect_sublat</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">defect_sublattices</span> <span class="o">=</span> <span class="p">[</span><span class="n">defect_sublattices</span><span class="p">]</span>
            <span class="n">num_defects</span> <span class="o">=</span> <span class="p">[</span><span class="n">num_defects</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">matcher_base</span> <span class="o">=</span> <span class="n">StructureMatcher</span><span class="p">(</span><span class="n">primitive_cell</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">allow_subset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">matcher_frame</span> <span class="o">=</span> <span class="n">StructureMatcher</span><span class="p">(</span>
            <span class="n">stol</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
            <span class="n">primitive_cell</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">allow_subset</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">comparator</span><span class="o">=</span><span class="n">FrameworkComparator</span><span class="p">(),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">calc_history</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cellsize</span> <span class="o">=</span> <span class="n">cellsize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_structure</span> <span class="o">=</span> <span class="n">base_structure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraint_func</span> <span class="o">=</span> <span class="n">constraint_func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraint_energy</span> <span class="o">=</span> <span class="n">constraint_energy</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_structure</span><span class="o">.</span><span class="n">num_sites</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># we need at least one site for make_supercell</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base_structure</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base_structure</span><span class="o">.</span><span class="n">make_supercell</span><span class="p">([</span><span class="n">cellsize</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cellsize</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cellsize</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base_structure</span><span class="o">.</span><span class="n">remove_sites</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_structure</span><span class="o">.</span><span class="n">num_sites</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base_structure</span><span class="o">.</span><span class="n">make_supercell</span><span class="p">([</span><span class="n">cellsize</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cellsize</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cellsize</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
        <span class="k">if</span> <span class="n">perfect_structure</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">perfect_structure</span> <span class="o">=</span> <span class="n">perfect_structure</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">perfect_structure</span><span class="o">.</span><span class="n">make_supercell</span><span class="p">(</span>
                <span class="p">[</span><span class="n">cellsize</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cellsize</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cellsize</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">supercell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_structure</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">matrix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_sublat</span> <span class="o">=</span> <span class="n">num_defect_sublat</span>
        <span class="n">invSuper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">supercell</span><span class="p">)</span>

        <span class="c1"># add supercell information to defect_sites</span>
        <span class="n">num_sites</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ntot_defects</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sublat_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">defect_sublattice</span> <span class="ow">in</span> <span class="n">defect_sublattices</span><span class="p">:</span>
            <span class="n">site_centers</span> <span class="o">=</span> <span class="n">defect_sublattice</span><span class="o">.</span><span class="n">site_centers</span>
            <span class="n">defect_sublattice</span><span class="o">.</span><span class="n">site_centers_sc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">cellsize</span><span class="p">)</span> <span class="o">*</span> <span class="n">site_centers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span>
            <span class="p">)</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">))</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span>
                    <span class="nb">range</span><span class="p">(</span><span class="n">cellsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                    <span class="nb">range</span><span class="p">(</span><span class="n">cellsize</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="nb">range</span><span class="p">(</span><span class="n">cellsize</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                    <span class="nb">range</span><span class="p">(</span><span class="n">site_centers</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="p">)</span>
            <span class="p">):</span>
                <span class="n">defect_sublattice</span><span class="o">.</span><span class="n">site_centers_sc</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">site_centers</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">defect_sublattice</span><span class="o">.</span><span class="n">site_centers_sc</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cellsize</span><span class="p">)</span>
            <span class="n">num_sites</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">defect_sublattice</span><span class="o">.</span><span class="n">site_centers_sc</span><span class="p">)</span>

            <span class="c1"># add vacancy</span>
            <span class="n">num_sites_sublat</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">defect_sublattice</span><span class="o">.</span><span class="n">site_centers_sc</span><span class="p">)</span>
            <span class="n">num_defects_sublat</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">num_defects</span><span class="p">[</span><span class="n">sublat_id</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">num_defects_sublat</span> <span class="o">+=</span> <span class="n">num</span>
            <span class="c1"># check if vacancy group has already been defined</span>
            <span class="k">for</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">defect_sublattice</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">grp</span><span class="o">.</span><span class="n">species</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">vac_name</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">name</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># otherwise, create a new group for vacancy</span>
                <span class="n">vac_name</span> <span class="o">=</span> <span class="s1">&#39;@&#39;</span>
                <span class="n">vac_group</span> <span class="o">=</span> <span class="n">Group</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">vac_name</span><span class="p">,</span> <span class="n">species</span><span class="o">=</span><span class="p">[])</span>
                <span class="n">defect_sublattice</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vac_group</span><span class="p">)</span>
                <span class="n">defect_sublattice</span><span class="o">.</span><span class="n">group_dict</span><span class="p">[</span><span class="n">vac_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">vac_group</span>
            <span class="c1"># append vacancy even if sites are full</span>
            <span class="n">nvac</span> <span class="o">=</span> <span class="n">num_sites_sublat</span> <span class="o">-</span> <span class="n">num_defects_sublat</span>
            <span class="n">num_defects</span><span class="p">[</span><span class="n">sublat_id</span><span class="p">][</span><span class="n">vac_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_defects</span><span class="p">[</span><span class="n">sublat_id</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">vac_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">nvac</span>
            <span class="n">defect_sublattice</span><span class="o">.</span><span class="n">vac_group</span> <span class="o">=</span> <span class="n">vac_name</span>

            <span class="c1"># change cartesian coordinates to fractional</span>
            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">defect_sublattice</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">orientations</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">natoms</span><span class="p">):</span>
                        <span class="n">group</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">invSuper</span><span class="p">)</span>

            <span class="c1"># fill the lattice gas representation list</span>
            <span class="n">latgas_rep</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">num_defects</span><span class="p">[</span><span class="n">sublat_id</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">latgas_rep</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                    <span class="p">[[</span><span class="n">group</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">)]</span>
                <span class="p">)</span>
                <span class="n">ntot_defects</span> <span class="o">+=</span> <span class="n">num</span>
            <span class="n">defect_sublattice</span><span class="o">.</span><span class="n">latgas_rep</span> <span class="o">=</span> <span class="n">latgas_rep</span>

            <span class="n">sublat_id</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">defect_sublattices</span> <span class="o">=</span> <span class="n">defect_sublattices</span>

        <span class="c1"># # table group.name to sublattice which the group belongs to</span>
        <span class="c1"># self.sublattice_dict = {}</span>
        <span class="c1"># for defect_sublattice in self.defect_sublattices:</span>
        <span class="c1">#     for grp in defect_sublattice.groups:</span>
        <span class="c1">#         self.sublattice_dict[grp.name] = self.sublattice_dict.get(grp.name, []) + [defect_sublattice]</span>

        <span class="k">assert</span> <span class="n">num_sites</span> <span class="o">==</span> <span class="n">ntot_defects</span>
        <span class="n">constraint_fullfilled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_latgas</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">constraint_fullfilled</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shuffle</span><span class="p">()</span>

        <span class="c1"># internal energy and grand potential</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">internal_energy</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">energy</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># store chemical potential parameters and grandcanonical move</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chemical_potential</span> <span class="o">=</span> <span class="n">chemical_potential</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gc_move</span> <span class="o">=</span> <span class="n">gc_move</span></div>

<div class="viewcode-block" id="Config.set_latgas"><a class="viewcode-back" href="../../../../abics.applications.latgas_abinitio_interface.model_setup.html#abics.applications.latgas_abinitio_interface.model_setup.Config.set_latgas">[docs]</a>    <span class="k">def</span> <span class="nf">set_latgas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">defect_sublattices</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        defect_sublattices: pymatgen.Structure</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        True if resulting structure satisifies constraints, False if not</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">defect_sublattices</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">defect_sublattices</span> <span class="o">=</span> <span class="n">defect_sublattices</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defect_sublattices</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_sublat</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_structure</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">defect_sublattice</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">defect_sublattices</span><span class="p">:</span>
            <span class="n">latgas_rep</span> <span class="o">=</span> <span class="n">defect_sublattice</span><span class="o">.</span><span class="n">latgas_rep</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">latgas_rep</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">defect_sublattice</span><span class="o">.</span><span class="n">site_centers_sc</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">isite</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">latgas_rep</span><span class="p">)):</span>
                <span class="n">grp_name</span> <span class="o">=</span> <span class="n">latgas_rep</span><span class="p">[</span><span class="n">isite</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">orr</span> <span class="o">=</span> <span class="n">latgas_rep</span><span class="p">[</span><span class="n">isite</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">group</span> <span class="o">=</span> <span class="n">defect_sublattice</span><span class="o">.</span><span class="n">group_dict</span><span class="p">[</span><span class="n">grp_name</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">natoms</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">group</span><span class="o">.</span><span class="n">species</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                        <span class="n">group</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">orr</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">defect_sublattice</span><span class="o">.</span><span class="n">site_centers_sc</span><span class="p">[</span><span class="n">isite</span><span class="p">],</span>
                        <span class="n">properties</span><span class="o">=</span><span class="p">{</span>
                            <span class="s2">&quot;seldyn&quot;</span><span class="p">:</span> <span class="n">group</span><span class="o">.</span><span class="n">relaxations</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:],</span>
                            <span class="s2">&quot;magnetization&quot;</span><span class="p">:</span> <span class="n">group</span><span class="o">.</span><span class="n">magnetizations</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                        <span class="p">},</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraint_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span></div>

<div class="viewcode-block" id="Config.reset_from_structure"><a class="viewcode-back" href="../../../../abics.applications.latgas_abinitio_interface.model_setup.html#abics.applications.latgas_abinitio_interface.model_setup.Config.reset_from_structure">[docs]</a>    <span class="k">def</span> <span class="nf">reset_from_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">st_in</span><span class="p">):</span>
        <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dummy_structure</span><span class="p">()</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">map2perflat</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">st_in</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">remove_species</span><span class="p">([</span><span class="s2">&quot;X&quot;</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">defect_sublattice</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">defect_sublattices</span><span class="p">:</span>    
            <span class="c1"># Extract group information for this sublattice</span>
            <span class="n">d_sp2grp</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">sp</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">defect_sublattice</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">species</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span>
                        <span class="s1">&#39;Cannot set initial structure when multi-atom groups are used&#39;</span>
                        <span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">species</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">d_sp2grp</span><span class="p">[</span><span class="s2">&quot;X0+&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">name</span>
                    <span class="n">sp</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">d_sp2grp</span><span class="p">[</span><span class="n">group</span><span class="o">.</span><span class="n">species</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">name</span>
                    <span class="n">sp</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">species</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="c1"># Map initial structure to sublattice</span>
            <span class="n">sublattice_dummy_st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dummy_structure_from_sublattice</span><span class="p">(</span><span class="n">defect_sublattice</span><span class="p">)</span>
            <span class="n">d_matrix</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">lattice</span><span class="o">.</span><span class="n">get_all_distances</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">,</span> <span class="n">sublattice_dummy_st</span><span class="o">.</span><span class="n">frac_coords</span><span class="p">)</span>
            <span class="n">mapping</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">d_matrix</span> <span class="o">&lt;</span> <span class="mf">1e-4</span><span class="p">)</span>
            <span class="n">num_match</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mapping</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_match</span><span class="p">):</span> 
                <span class="n">sublattice_dummy_st</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">mapping</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">st</span><span class="p">[</span><span class="n">mapping</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">species_string</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">sp</span><span class="o">.</span><span class="n">issuperset</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">sublattice_dummy_st</span><span class="o">.</span><span class="n">symbol_set</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span>
                    <span class="s2">&quot;Initial structure contains species </span><span class="si">{}</span><span class="s2"> not specified in config&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">sp</span> <span class="o">^</span> <span class="nb">set</span><span class="p">(</span><span class="n">sublattice_dummy_st</span><span class="o">.</span><span class="n">symbol_set</span><span class="p">)</span>
                        <span class="p">)</span> <span class="o">+</span> \
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">(if species &#39;X&#39; is listed here, it means the number of atoms don&#39;t match)&quot;</span>
                <span class="p">)</span>
                
            <span class="c1"># Set lattice gas representation list</span>
            <span class="n">latgas_rep</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">isite</span><span class="p">,</span> <span class="n">site</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sublattice_dummy_st</span><span class="p">):</span>
                <span class="n">latgas_rep</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">d_sp2grp</span><span class="p">[</span><span class="n">site</span><span class="o">.</span><span class="n">species_string</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span>
            <span class="n">defect_sublattice</span><span class="o">.</span><span class="n">latgas_rep</span> <span class="o">=</span> <span class="n">latgas_rep</span>

        <span class="n">constraint_fullfilled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_latgas</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">constraint_fullfilled</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InputError</span><span class="p">(</span>
                <span class="s2">&quot;initial structure violates constraints specified by constraint_func&quot;</span>
                <span class="p">)</span></div>

<div class="viewcode-block" id="Config.dummy_structure"><a class="viewcode-back" href="../../../../abics.applications.latgas_abinitio_interface.model_setup.html#abics.applications.latgas_abinitio_interface.model_setup.Config.dummy_structure">[docs]</a>    <span class="k">def</span> <span class="nf">dummy_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Structure where all atoms and vacancies are replaced by dummy atoms</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dummy_structure</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_structure</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">defect_sublattice</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">defect_sublattices</span><span class="p">:</span>
            <span class="n">latgas_rep</span> <span class="o">=</span> <span class="n">defect_sublattice</span><span class="o">.</span><span class="n">latgas_rep</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">latgas_rep</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">defect_sublattice</span><span class="o">.</span><span class="n">site_centers_sc</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">isite</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">latgas_rep</span><span class="p">)):</span>
                <span class="n">grp_name</span> <span class="o">=</span> <span class="n">latgas_rep</span><span class="p">[</span><span class="n">isite</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">orr</span> <span class="o">=</span> <span class="n">latgas_rep</span><span class="p">[</span><span class="n">isite</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">group</span> <span class="o">=</span> <span class="n">defect_sublattice</span><span class="o">.</span><span class="n">group_dict</span><span class="p">[</span><span class="n">grp_name</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">group</span><span class="o">.</span><span class="n">natoms</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">dummy_structure</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="s2">&quot;X&quot;</span><span class="p">,</span>
                        <span class="n">defect_sublattice</span><span class="o">.</span><span class="n">site_centers_sc</span><span class="p">[</span><span class="n">isite</span><span class="p">],</span>
                        <span class="n">properties</span><span class="o">=</span><span class="p">{</span>
                            <span class="s2">&quot;seldyn&quot;</span><span class="p">:</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
                            <span class="s2">&quot;magnetization&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                        <span class="p">},</span>
                    <span class="p">)</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">natoms</span><span class="p">):</span>
                    <span class="n">dummy_structure</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="s2">&quot;X&quot;</span><span class="p">,</span>
                        <span class="n">group</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">orr</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">defect_sublattice</span><span class="o">.</span><span class="n">site_centers_sc</span><span class="p">[</span><span class="n">isite</span><span class="p">],</span>
                        <span class="n">properties</span><span class="o">=</span><span class="p">{</span>
                            <span class="s2">&quot;seldyn&quot;</span><span class="p">:</span> <span class="n">group</span><span class="o">.</span><span class="n">relaxations</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:],</span>
                            <span class="s2">&quot;magnetization&quot;</span><span class="p">:</span> <span class="n">group</span><span class="o">.</span><span class="n">magnetizations</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                        <span class="p">},</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="n">dummy_structure</span></div>

<div class="viewcode-block" id="Config.dummy_structure_sp"><a class="viewcode-back" href="../../../../abics.applications.latgas_abinitio_interface.model_setup.html#abics.applications.latgas_abinitio_interface.model_setup.Config.dummy_structure_sp">[docs]</a>    <span class="k">def</span> <span class="nf">dummy_structure_sp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">species_in</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        species (str): name of species for constructing dummy lattice</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Structure where all atoms and vacancies are replaced by dummy atoms</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dummy_structure</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_structure</span><span class="p">)</span>
        <span class="n">sp_remove</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">sp</span><span class="p">:</span> <span class="n">sp</span> <span class="o">!=</span> <span class="n">species_in</span><span class="p">,</span> <span class="n">dummy_structure</span><span class="o">.</span><span class="n">symbol_set</span><span class="p">)</span>
        <span class="n">dummy_structure</span><span class="o">.</span><span class="n">remove_species</span><span class="p">(</span><span class="n">sp_remove</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">defect_sublattice</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">defect_sublattices</span><span class="p">:</span>
            <span class="n">latgas_rep</span> <span class="o">=</span> <span class="n">defect_sublattice</span><span class="o">.</span><span class="n">latgas_rep</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">latgas_rep</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">defect_sublattice</span><span class="o">.</span><span class="n">site_centers_sc</span><span class="p">)</span>
            <span class="c1"># find all species that can reside on this lattice</span>
            <span class="n">species_sublattice</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="n">defect_sublattice</span><span class="o">.</span><span class="n">group_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">grp_name</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
                <span class="n">group</span> <span class="o">=</span> <span class="n">defect_sublattice</span><span class="o">.</span><span class="n">group_dict</span><span class="p">[</span><span class="n">grp_name</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">group</span><span class="o">.</span><span class="n">natoms</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;dummy_structure_sp does not support multi-atom groups&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">group</span><span class="o">.</span><span class="n">natoms</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">species_sublattice</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">species</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">species_in</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">species_sublattice</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">isite</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">latgas_rep</span><span class="p">)):</span>
                <span class="n">dummy_structure</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="s2">&quot;X&quot;</span><span class="p">,</span>
                    <span class="n">defect_sublattice</span><span class="o">.</span><span class="n">site_centers_sc</span><span class="p">[</span><span class="n">isite</span><span class="p">],</span>
                    <span class="n">properties</span><span class="o">=</span><span class="p">{</span>
                        <span class="s2">&quot;seldyn&quot;</span><span class="p">:</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
                        <span class="s2">&quot;magnetization&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                    <span class="p">},</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">dummy_structure</span></div>

<div class="viewcode-block" id="Config.dummy_structure_from_sublattice"><a class="viewcode-back" href="../../../../abics.applications.latgas_abinitio_interface.model_setup.html#abics.applications.latgas_abinitio_interface.model_setup.Config.dummy_structure_from_sublattice">[docs]</a>    <span class="k">def</span> <span class="nf">dummy_structure_from_sublattice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">defect_sublattice</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        defect_sublattice (str): defect_sublattice for constructing dummy lattice</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Structure where all atoms and vacancies are replaced by dummy atoms</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dummy_structure</span> <span class="o">=</span> <span class="n">Structure</span><span class="p">(</span>
            <span class="n">lattice</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_structure</span><span class="o">.</span><span class="n">lattice</span><span class="p">,</span>
            <span class="n">species</span><span class="o">=</span><span class="p">[],</span>
            <span class="n">coords</span><span class="o">=</span><span class="p">[],</span>
            <span class="p">)</span>
        

        <span class="n">latgas_rep</span> <span class="o">=</span> <span class="n">defect_sublattice</span><span class="o">.</span><span class="n">latgas_rep</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">latgas_rep</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">defect_sublattice</span><span class="o">.</span><span class="n">site_centers_sc</span><span class="p">)</span>
        <span class="c1"># find all species that can reside on this lattice</span>
        <span class="n">species_sublattice</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="n">defect_sublattice</span><span class="o">.</span><span class="n">group_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">grp_name</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
            <span class="n">group</span> <span class="o">=</span> <span class="n">defect_sublattice</span><span class="o">.</span><span class="n">group_dict</span><span class="p">[</span><span class="n">grp_name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">group</span><span class="o">.</span><span class="n">natoms</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;dummy_structure_sp does not support multi-atom groups&quot;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">group</span><span class="o">.</span><span class="n">natoms</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">species_sublattice</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">species</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">isite</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">latgas_rep</span><span class="p">)):</span>
            <span class="n">dummy_structure</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s2">&quot;X&quot;</span><span class="p">,</span>
                <span class="n">defect_sublattice</span><span class="o">.</span><span class="n">site_centers_sc</span><span class="p">[</span><span class="n">isite</span><span class="p">],</span>
                <span class="n">properties</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;seldyn&quot;</span><span class="p">:</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
                    <span class="s2">&quot;magnetization&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="p">},</span>
            <span class="p">)</span>
                
        <span class="k">return</span> <span class="n">dummy_structure</span></div>

<div class="viewcode-block" id="Config.shuffle"><a class="viewcode-back" href="../../../../abics.applications.latgas_abinitio_interface.model_setup.html#abics.applications.latgas_abinitio_interface.model_setup.Config.shuffle">[docs]</a>    <span class="k">def</span> <span class="nf">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">max_trial</span> <span class="o">=</span> <span class="mi">1000</span>
        <span class="n">num_trial</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">num_trial</span> <span class="o">&lt;</span> <span class="n">max_trial</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">defect_sublattice</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">defect_sublattices</span><span class="p">:</span>
                <span class="n">latgas_rep</span> <span class="o">=</span> <span class="n">defect_sublattice</span><span class="o">.</span><span class="n">latgas_rep</span>
                <span class="n">rand</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">latgas_rep</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">latgas_rep</span><span class="p">:</span>
                    <span class="n">group</span> <span class="o">=</span> <span class="n">defect_sublattice</span><span class="o">.</span><span class="n">group_dict</span><span class="p">[</span><span class="n">site</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="n">norr</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">orientations</span>
                    <span class="n">site</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rand</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">norr</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_latgas</span><span class="p">():</span> 
                <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Configuration initialized randomly&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraint_energy</span><span class="p">:</span> 
                    <span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraint_energy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span>
                    <span class="n">num_trial</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">while</span> <span class="n">num_trial</span> <span class="o">&lt;</span> <span class="n">max_trial</span><span class="p">:</span> 
                        <span class="n">num_trial</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">defect_sublattice</span> <span class="o">=</span> <span class="n">rand</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defect_sublattices</span><span class="p">)</span>
                        <span class="n">latgas_rep</span> <span class="o">=</span> <span class="n">defect_sublattice</span><span class="o">.</span><span class="n">latgas_rep</span>
                        <span class="n">i0</span><span class="p">,</span> <span class="n">i1</span> <span class="o">=</span> <span class="n">rand</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">latgas_rep</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
                        <span class="n">latgas_rep</span><span class="p">[</span><span class="n">i0</span><span class="p">],</span> <span class="n">latgas_rep</span><span class="p">[</span><span class="n">i1</span><span class="p">]</span> <span class="o">=</span> <span class="n">latgas_rep</span><span class="p">[</span><span class="n">i1</span><span class="p">],</span> <span class="n">latgas_rep</span><span class="p">[</span><span class="n">i0</span><span class="p">]</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_latgas</span><span class="p">():</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;---constraint_module.constraint_energy was used&quot;</span> <span class="o">+</span> \
                                <span class="s2">&quot; to find configuration that follows constraints with </span><span class="si">{}</span><span class="s2"> trials&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_trial</span><span class="p">)</span>
                            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="n">msg</span>
                        <span class="n">e1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraint_energy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">e1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;There&#39;s something wrong: constraint_func and constraint_energy are inconsistent&quot;</span>
                            <span class="k">return</span> <span class="mi">1</span><span class="p">,</span> <span class="n">msg</span>
                        <span class="k">if</span> <span class="n">e1</span> <span class="o">&gt;</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">latgas_rep</span><span class="p">[</span><span class="n">i0</span><span class="p">],</span> <span class="n">latgas_rep</span><span class="p">[</span><span class="n">i1</span><span class="p">]</span> <span class="o">=</span> <span class="n">latgas_rep</span><span class="p">[</span><span class="n">i1</span><span class="p">],</span> <span class="n">latgas_rep</span><span class="p">[</span><span class="n">i0</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">e</span> <span class="o">=</span> <span class="n">e1</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Failed to find configuration with constraint_module.constraint_energy after </span><span class="si">{}</span><span class="s2"> trials&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_trial</span><span class="p">)</span>
                    <span class="k">return</span> <span class="mi">1</span><span class="p">,</span> <span class="n">msg</span>
                    
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">num_trial</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Failed to find configuration that follows constraints by random shuffling. Try setting constraint_energy.&quot;</span>       
        <span class="k">return</span> <span class="mi">1</span><span class="p">,</span> <span class="n">msg</span></div>



<div class="viewcode-block" id="Config.count"><a class="viewcode-back" href="../../../../abics.applications.latgas_abinitio_interface.model_setup.html#abics.applications.latgas_abinitio_interface.model_setup.Config.count">[docs]</a>    <span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_name</span><span class="p">,</span> <span class="n">orientation</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        group_name: str</span>
<span class="sd">            The name of the group</span>
<span class="sd">        orientation:</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">num_grp</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">defect_sublattice</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">defect_sublattices</span><span class="p">:</span>
            <span class="n">num_grp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">defect_sublattice</span><span class="o">.</span><span class="n">latgas_rep</span><span class="o">.</span><span class="n">count</span><span class="p">([</span><span class="n">group_name</span><span class="p">,</span> <span class="n">orientation</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">num_grp</span></div>

<div class="viewcode-block" id="Config.update_basestruct"><a class="viewcode-back" href="../../../../abics.applications.latgas_abinitio_interface.model_setup.html#abics.applications.latgas_abinitio_interface.model_setup.Config.update_basestruct">[docs]</a>    <span class="k">def</span> <span class="nf">update_basestruct</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">basesites</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matcher_base</span><span class="o">.</span><span class="n">get_mapping</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_structure</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">basesites</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base_structure</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="Config.defect_sublattice_structure"><a class="viewcode-back" href="../../../../abics.applications.latgas_abinitio_interface.model_setup.html#abics.applications.latgas_abinitio_interface.model_setup.Config.defect_sublattice_structure">[docs]</a>    <span class="k">def</span> <span class="nf">defect_sublattice_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sublat_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sublat_id: int</span>
<span class="sd">            index of sublattice</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        sublattice_structure: pymatgen.Structure</span>
<span class="sd">            sublattice structure object</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">sublat_id</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_sublat</span>
        <span class="n">sublattice_structure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">base_sites</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matcher_base</span><span class="o">.</span><span class="n">get_mapping</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_structure</span><span class="p">)</span>
        <span class="n">sublattice_structure</span><span class="o">.</span><span class="n">remove_sites</span><span class="p">(</span><span class="n">base_sites</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sublattice_structure</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">vacancy_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">filledsites</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matcher_frame</span><span class="o">.</span><span class="n">get_mapping</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">perfect_structure</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span>
        <span class="p">)</span>
        <span class="n">vac_structure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">perfect_structure</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">vac_structure</span><span class="o">.</span><span class="n">remove_sites</span><span class="p">(</span><span class="n">filledsites</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">vac_structure</span></div>


<span class="c1"># For backward compatibility</span>
<span class="k">if</span> <span class="n">__version__</span> <span class="o">&lt;</span> <span class="s2">&quot;3&quot;</span><span class="p">:</span>
    <span class="n">dft_latgas</span> <span class="o">=</span> <span class="n">DFTLatticeGas</span>
    <span class="n">energy_lst</span> <span class="o">=</span> <span class="n">EnergyList</span>
    <span class="n">group</span> <span class="o">=</span> <span class="n">Group</span>
    <span class="n">defect_sublattice</span> <span class="o">=</span> <span class="n">DefectSublattice</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020-, ISSP, UTokyo.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>