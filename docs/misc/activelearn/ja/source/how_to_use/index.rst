.. _sec_basic_usage:

***************************
基本的な使用方法
***************************

.. highlight:: none

aenetのインストール
-----------------------

abICSでは、ニューラルネットワークモデルの構築のためにaenetを利用します。
aenetは http://ann.atomistic.net からダウンロードすることが可能です。
DocumentationのInstallationに従い、インストールを実施します。
なお、abICSでは、ニューラルネットワークの学習と評価にaenetの ``train.x`` と ``predict.x`` を使います。
train.xについてはMPI並列版が利用可能ですが、predict.xについてはMPIを使用しない実行ファイル(serial)を使用する必要があります。
そのため、makefilesの下にあるserial版もインストールするようにしてください。

GNU parallelのインストール(オプション)
-----------------------------------------
チュートリアルではGNU parallelを用いて、Quantum Espressoによる第一原理計算を並列実行します。
そこで、GNU parallelを最初にインストールします。
GNU parallelは https://www.gnu.org/software/parallel/ からダウンロードすることができます(Macの場合はhomebrewにより直接インストールすることも可能です)。
また、オンラインで無償で利用できるチュートリアルを本サイトで配布しています。
インストールは基本的には、ダウンロードして解凍したディレクトリ に移動した後、

::

  $ ./configure && make && make install

でインストールできます。詳細な設定は公式マニュアルを参考にしてください。

Active learningの実施
-----------------------

学習データの生成
++++++++++++++++++++++++++++++++++++++++++++++++++++
abICS Ver. 2では、構造最適化後のエネルギーを高速に予測するニューラルネットワークモデルを使ってエネルギー計算を
行い、レプリカ交換法によるモンテカルロサンプリングを行います。ニューラルネットワークモデルを利用する前に、
理想格子上の様々な原子配置と、そこから第一原理計算によって構造最適化した後のエネルギーの対応関係を学習させる
必要があります。このための学習データを用意します。


(i)  第一原理計算用入力ファイルの生成
****************************************************

abics_activelearnを用いて、学習データの大元となる第一原理計算用の入力ファイルを生成します。初回実行時は、
指定した数だけ原子配置をランダムに生成し、それぞれの原子配置に対して個別のディレクトリを用意し、入力ファイルを
設置します。同時に、それらのディレクトリのpathが記載されたファイルrundirs.txtも生成します。
このディレクトリリストを使って、個々の入力に対する第一原理計算ジョブの実行を自動化することができます。
本チュートリアルでは、スケジューラとして
slurmがインストールされている共用計算機を念頭に、gnu parallelを利用した一括実行方法を紹介します。

abics_activelearnの入力ファイルの情報は以下の通りで、[solverRef]セクションにある情報を読み取り、第一原理計算用の入力ファイルを生成します。

- type : 第一原理計算ソルバーを表します。 'vasp', 'qe', 'openmx'が選択できます。

- path: aenetの実行ファイル(predict.x)へのパスを指定します。

- base_input_dir: 第一原理ソルバーの参照する入力ファイルが格納されたディレクトリのリストを表します。

- perturb, run_scheme, ignore\_species:  [solver]セクションと同様。

abics\_activelearnでは、baseinput\_dirにあるフォルダの入力ファイルを利用し、計算用入力ファイルの生成が行われます
(厳しい条件で計算させたい場合などに、複数入力ファイルを準備するなどの応用も可能)。
実行すると中間ファイルを出力し、abics\_activelearnを実行した回数を記録します。
それを読み取ることで、baseinput\_dirの対応する入力フォルダに格納された入力ファイルを読み込みます。
実行回数がbaseinput\_dirの要素よりも多い場合には、エラーを吐きます。

(ii)  第一原理計算の実行
****************************************************

(i)で作成した入力ファイルをもとに第一原理計算を実行します。
gnu parallelを用いて計算する場合には、rundirs.txtを-aオプションで指定することで簡単に並列計算を実施することができます。

baseinput\_dirで複数回実行する場合には、abics\_activelearnの実行と(ii)の計算を回数分実行する必要があります。


aenetを用いたニューラルネットワークポテンシャルの作成
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

abics_trainで作成した第一原理計算の計算結果をaenetを用いて学習し、ニューラルネットワークポテンシャルを作成します。
abics_trainの入力情報は[trainer]セクションで記載します。各パラメータの説明は以下の通りです。

- type: ニューラルネットワークポテンシャルを生成するための学習器 (現状では 'aenet' のみ)
- base_input_dir:  学習器が参照する入力ファイルが格納されたディレクトリのパス。
- exe_command:  実行コマンドのリスト。aenetを利用する場合は、generate.xとtrain.xへのパスを指定する必要があります。
- ignore_species: [solver]セクションと同様。

aenetをソルバーとして利用しモンテカルロ法を利用した構造推定
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

abICSを走らせてモンテカルロ法を利用してします。
[solver]セクションのtypeをaenetに変更し、pathにpredict.xへのパスを通します。
また、base_input_dirには、predict.xの実行用に、(b)で作成されたニューラルネットワークと入力ファイルを置かれたディレクトリへのパスを指定します。
入力ファイル作成後、abICSを実行させることで、構造推定が行われます。

