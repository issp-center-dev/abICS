.. _sec_basic_usage:

***************************
Basic Usage
***************************

.. highlight:: none

In abICS, all solver and sampler parameters other than the position coordinates must be prepared in advance.
To this end, abICS requires two input files: (1) a reference file for specifiying solver parameters that is formatted according to the solver input format,
and (2) an input file for specifying parameters that control how abICS performs the configurational sampling.

.. _subsec_basic_reference:

Preparing a reference file for active learning
===============================================

The user must prepare a reference file for active learning according to the input format of the solver to be used.
The path of the reference file is specified by ``base_input_dir`` in the ``[mlref.solver]`` section in the abICS input file (see below).
The coordinate information should not be written here because it will obviously change in the course of the simulation.
The following is an example of a QE reference file.

.. literalinclude::  ../../../../../examples/spinel/baseinput/scf.in

.. _solver_specific_notes:

Specific notes of solvers for active learning
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

In abICS, the coordinates of atoms are updated. Other settings are basically specified on the reference file for each solver.
However, the specification of atoms to be relaxed can be controlled by abICS.
To enable the structural optimization option, please set the option to do structural optimization in the reference file of the solver, and also specify the related parameters such as the total number of steps for relaxation.
Furthermore, in abICS, a reference file name, a rule of a reference file, and an executable format ``run_scheme`` in the input file of abICS must be set on a solver-by-solver basis. We'll explain them below.

VASP
****

- URL : https://www.vasp.at

- Rules of a reference file

  - Please prepare INCAR, POTCAR, KPOINTS files.

    - In POTCAR file, please arrange the atoms in alphabetical order.
    - The POSCAR file is basically not needed, but maybe needed depending on the version of ``pymatgen``.
      In that case, please prepare a suitable file.



Quantum Espresso
****************

- URL : https://www.quantum-espresso.org

- Available version: 6.2 or higher

  - "Old XML" format is not available

- Rules of a reference file

  - Please set a reference file name as ``scf.in`` .
  - ``calculation`` option must be ``scf`` or ``relax`` .
  - If the calculation is done only at :math:`\Gamma` point, the calculation becomes fast if you set ``Gamma`` in ``kpoints``.


OpenMX
******

- URL : http://www.openmx-square.org

- Available version: 3.9

- A rule of reference file

  - Please set a reference file name as ``base.dat`` .


Preparing a reference file
===========================

The user must prepare a reference file according to the input format of the solver to be used.
The path of the reference file is specified by ``base_input_dir`` in the ``[solver]`` section in the abICS input file (see below).
The coordinate information should not be written here because it will obviously change in the course of the simulation. 
The lattice sites are specified in a separate abICS input file (see below), 
and abICS will take care of generating the coordinates section at each sampling step.
The following is an example of an aenet reference file.

.. literalinclude::  ../../../../../examples/spinel/baseinput/predict.in

.. _solver_specific_notes:

Solver specific notes
~~~~~~~~~~~~~~~~~~~~~

aenet
*****

- URL : http://ann.atomistic.net

- Checked with version 2.0.3 (2018-06-25).

- A rule of referene file

  - Place the input files for aenet in the ``generate``, ``train``, and ``predict`` directories in the directory which is set in the ``base_input_dir`` of the ``[trainer]`` section.

  - aenet compiles the atomic configuration and energy data for training into an intermediate binary format that is converted to atomic environment descriptor-energy relationships before training. Please place the input files for this conversion ``generate.x`` in the ``generate`` directory.

  - Place an input file for ``train.x`` in the ``train`` directory that reads the training data generated by ``generate.x`` and trains. The file should be named ``train.in``.

  - Place the input file ``predict.in`` for ``predict.x`` in the ``predict`` directory to evaluate the energy for the input coordinates using the trained potential model.


- A rule of an input file of abICS

  -  In the ``[solver]`` section, for ``type`` , ``perturb`` , and ``run_scheme``, set the following if using an active learning scheme.

  .. code-block:: bash

     type = “aenet”
     perturb = 0.0
     run_scheme = ‘subprocess’


.. _subsec_basic_input:

Preparing an input file of abICS		    
================================

The input file of abICS is constructed by the following five sections:

1. [sampling] section specifies the parameters of the replica exchange Monte Carlo part, such as the number of replicas, the temperature range, and the number of Monte Carlo steps. In addition, [sampling.solver] subsection specifies the parameters for the (first principle calculation) solver, including the type of solver (VASP, QE,...), the path to the solver, and the directory containing immutable input files.

2. [mlref] section specifies options for extracting only atomic configurations from the sampling results in order to evaluate the accuracy of the neural network model and to expand the training data. In addition, for generating training data, [mlref.solver] subsection specifies the parameters for the (first principle calculation) solver, including the type of solver (VASP, QE,...), the path to the solver, and the directory containing immutable input files. This section is used for ``abics_mlref`` .

3. [train] section specifies optinons for making a trainer to learn a placement energy prediction model from training data.  This section is used for ``abics_train`` .

4. [observer] section specifies the type of physical quantity to be calculated.

5. [config] section specifies the configuration of the alloy, etc.

For details, see :doc:`../inputfiles/index` .
The following is an example of an input file selecting aenet as a solver.

.. literalinclude::  ../../../../../examples/spinel/input_aenet.toml

Creating a set of training data
================================

1. Generate a set of input files for the first-principle calculation using ``abics_mlref``.

2. Perform the first-principle calculation with these inputs. (In the tutorial GNU parallel is used for the exhaustive calculation.)

Creating a neural network
==========================

1. Run ``abics_mlref`` again to convert the results of the first-principle calculation into a common format that ``abics_train`` will read.

2. Execute ``abics_train`` to create a neural network. When the calculation is completed successfully, the trained neural network is output in ``baseinput`` directory.

Monte Carlo samplings
=============================

By using ``abics_sampling``, Monte Carlo samplings can be performed by using the trained neural network.
(The number of MPI processes must be larger than the number of replicas.)
Running the program will create directories named by the replica numbers under the current directory, 
and each replica runs the solver in it.

.. image:: ../../../image/al_scheme.pdf
   :width: 800px
   :align: center

A schematic view of the active learning in abICS.

.. solver_specific_notes:
